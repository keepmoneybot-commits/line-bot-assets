// ==========================================
// 1. è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸å€
// ==========================================
const DEVELOPER_EMAIL = 'service-account@my-money-bot-483007.iam.gserviceaccount.com'; 
const TEMPLATE_URL = 'https://docs.google.com/spreadsheets/d/1PJXM5HSKoFJYvk_-ppD-sogDWtsFxUDZL2CxBEe9OfE/copy';
const MASTER_SHEET_ID = '1s7mFm5EHZDwvASudCVgwFRQ3cCK74OHXqDf0UittK8M'; 
const CHANNEL_ACCESS_TOKEN = '+ilP841/s0Sg9oQcKs9clx8YclGBjKGZIdQY/o8GI8hTPvCNZb9+vWWP4Pxwr2srRGd6E45Z3E/HyOU+h0JgX1qLkxK3pdeQqdwpLY91+34dYvf2rx4sdQyEgHYcPbgc92YWDE2dZYocQY4ryg1xVAdB04t89/1O/w1cDnyilFU=';
const DEBUG_KEY = '#SYSTEM_RESET#'; 

// ğŸ¨ [æœˆæ›†é…è‰²] ç¶ è‰²æ¸…æ–° + è³ªæ„Ÿç°é‡‘é¡
const CALENDAR_COLORS = {
    headerBg: "#66BB6A",      // æ¨™é¡Œï¼šæŸ”å’Œè‰ç¶ 
    headerText: "#FFFFFF",
    noDataBg: "#FAFAFA",      // ç„¡è³‡æ–™ï¼šæ¥µæ·¡ç°
    noDataText: "#CFD8DC",    // ç„¡è³‡æ–™æ—¥æœŸï¼šæ·ºè—ç°
    hasDataBg: "#E8F5E9",     // æœ‰è³‡æ–™ï¼šæ·¡è–„è·ç¶ 
    hasDataText: "#616161",   // æœ‰è³‡æ–™æ—¥æœŸï¼šæ·±ç°
    priceText: "#9E9E9E",     // é‡‘é¡ï¼šæ·¡ç°è‰² (ä½èª¿)
    todayBg: "#FFEBEE",       // ä»Šå¤©èƒŒæ™¯ï¼šæ·¡ç²‰ç´…
    todayText: "#616161",     // ä»Šå¤©æ—¥æœŸï¼šæ·±ç°
    todayBorder: "#EF9A9A",   // ä»Šå¤©é‚Šæ¡†
    weekdayText: "#90A4AE"    // æ˜ŸæœŸæ¨™é¡Œ
};

// ğŸ¨ [ä¿®æ”¹] æˆå°±é›£åº¦èƒŒæ™¯è‰² (Lv1~Lv5)
const LEVEL_COLORS = {
  1: '#FFFFFF', // Lv1 æ™®é€š (ç™½)
  2: '#E8F5E9', // Lv2 å„ªè‰¯ (æ¥µæ·¡ç¶ )
  3: '#E3F2FD', // Lv3 ç¨€æœ‰ (æ¥µæ·¡è—)
  4: '#F3E5F5', // Lv4 å²è©© (æ¥µæ·¡ç´«)
  5: '#FFF3E0'  // Lv5 å‚³èªª (æ¥µæ·¡æ©˜)
};

// ğŸ¨ [ä¿®æ”¹] æ¡†ç·šé¡è‰²
const LEVEL_BORDER_COLORS = {
  1: '#D6D6D6', 2: '#B7E8B9', 3: '#B8DEFC', 4: '#F0C6F7', 5: '#FFC875'
};

// ğŸ¨ [æ–°å¢] æ¨™é¡Œæ–‡å­—é¡è‰²
const LEVEL_TEXT_COLORS = {
  1: '#616161', 2: '#2E7D32', 3: '#1565C0', 4: '#6A1B9A', 5: '#EF6C00'
};

// ğŸ† æˆå°±å®šç¾© (å…¨åˆ†é¡æ•´ç†ç‰ˆ)
const ACHIEVEMENTS = {
  // 1. [MILESTONE] é‡Œç¨‹ç¢‘ - è¨˜å¸³æ¬¡æ•¸èˆ‡åŸºç¤
  'FIRST_NOTE': { title: 'ğŸŒ± æ–°æ‰‹ä¸Šè·¯', desc: 'åƒé‡Œä¹‹è¡Œï¼Œå§‹æ–¼è¶³ä¸‹ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é–‹å§‹è¨˜å¸³ æœ‰é—œ', hint: 'æˆåŠŸè¨˜ä¸‹ç¬¬ 1 ç­†å¸³', level: 1, group: 'MILESTONE' },
  'NOTE_10':    { title: 'ğŸ“ è¨˜å¸³å­¸å¾’', desc: 'é¤Šæˆç¿’æ…£çš„ç¬¬ä¸€æ­¥ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è¨˜å¸³æ¬¡æ•¸ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³æ»¿ 10 ç­†', level: 1, group: 'MILESTONE' },
  'NOTE_50':    { title: 'ğŸ”¥ æŒä¹‹ä»¥æ†', desc: 'ä½ å·²ç¶“è¶…è¶Šäº† 80% çš„äººã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è¨˜å¸³æ¬¡æ•¸ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³æ»¿ 50 ç­†', level: 2, group: 'MILESTONE' },
  'NOTE_100':   { title: 'ğŸ“ è¨˜å¸³å¤§å¸«', desc: 'è¨˜å¸³å·²ç¶“æˆç‚ºä½ ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è¨˜å¸³æ¬¡æ•¸ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³æ»¿ 100 ç­†', level: 3, group: 'MILESTONE' },
  'STREAK_7':   { title: 'ğŸ—“ï¸ ä¸€é€±å…¨å‹¤', desc: 'ä½ çš„è‡ªå¾‹ä»¤äººä½©æœï¼', fuzzy: 'ä¼¼ä¹èˆ‡ é€£çºŒè¨˜å¸³ æœ‰é—œ', hint: 'é€£çºŒ 7 å¤©éƒ½æœ‰è¨˜å¸³', level: 3, group: 'MILESTONE' },
  'CRAMMER':    { title: 'ğŸ”¥ è‡¨æ™‚æŠ±ä½›è…³', desc: 'é€™åˆ°åº•ç®—è¨˜å¾—é‚„æ˜¯å¿˜è¨˜ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ è£œè¨˜å¸³ æœ‰é—œ', hint: 'é€£çºŒè£œè¨˜å¸³ç›®é” 5 ç­†', level: 3, group: 'MILESTONE' },

  // 2. [TIME] æ™‚é–“ç®¡ç† - ä»€éº¼æ™‚å€™è¨˜å¸³
  'EARLY_BIRD': { title: 'ğŸŒ æ—©å®‰æ™¨ä¹‹ç¾', desc: 'ä¸€æ—¥ä¹‹è¨ˆåœ¨æ–¼æ™¨ï¼', fuzzy: 'ä¼¼ä¹èˆ‡ è¨˜å¸³æ™‚é–“ æœ‰é—œ', hint: 'åœ¨ 05:00 ~ 09:00 ä¹‹é–“è¨˜å¸³', level: 2, group: 'TIME' },
  'NIGHT_OWL':  { title: 'ğŸ¦‰ æœˆé»‘é¢¨é«˜', desc: 'è©²ä¸æœƒç¡åˆ°ä¸€åŠçˆ¬èµ·ä¾†è¨˜å¸³å§ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ è¨˜å¸³æ™‚é–“ æœ‰é—œ', hint: 'åœ¨ 01:00 ~ 04:00 ä¹‹é–“è¨˜å¸³', level: 2, group: 'TIME' },
  'LUNCH_TIME': { title: 'ğŸ± æº–æ™‚æ”¾é£¯', desc: 'å·¥ä½œæ”¾ä¸€é‚Šï¼Œåƒé£¯æœ€é‡è¦ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è¨˜å¸³æ™‚é–“ æœ‰é—œ', hint: 'åœ¨ 12:00 ~ 12:30 è¨˜åˆé¤', level: 2, group: 'TIME' },
  'MIDNIGHT_SNACK': { title: 'ğŸŒ™ ç½ªæƒ¡å®µå¤œ', desc: 'é€™æ™‚é–“åƒæ±è¥¿ï¼Œç†±é‡æ˜¯å…©å€å–”ï¼', fuzzy: 'ä¼¼ä¹èˆ‡ å®µå¤œæ™‚é–“ æœ‰é—œ', hint: 'åœ¨ 23:00 ~ 04:00 ä¹‹é–“è¨˜å¸³ã€Œä¼™é£Ÿã€', level: 2, group: 'TIME' },

  // 3. [WEALTH] è²¡å¯Œèˆ‡é‡‘é¡ - éŒ¢çš„å¤§å°äº‹
  'MICRO_PAY':  { title: 'ğŸ¤ é‡‘é‡‘è¨ˆè¼ƒ', desc: 'å°±ç®—æ˜¯ä¸€å¡ŠéŒ¢ä¹Ÿåˆ¥æƒ³é€ƒã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é‡‘é¡æ•¸å­— æœ‰é—œ', hint: 'å–®ç­†æ”¯å‡ºå°æ–¼ $5', level: 2, group: 'WEALTH' },
  'OCD_PAY':    { title: 'âš–ï¸ å¼·è¿«ç—‡æ‚£è€…', desc: 'çœ‹äº†çœŸèˆ’æœã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é‡‘é¡æ•¸å­— æœ‰é—œ', hint: 'é‡‘é¡å°¾æ•¸æ˜¯ 00', level: 1, group: 'WEALTH' },
  'BIG_EARN':   { title: 'ğŸ’° ç¬¬ä¸€æ¡¶é‡‘', desc: 'è²¡å¯Œè‡ªç”±æŒ‡æ—¥å¯å¾…ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ æ”¶å…¥é‡‘é¡ æœ‰é—œ', hint: 'å–®ç­†æ”¶å…¥è¶…é $10,000', level: 1, group: 'WEALTH' },
  'BIG_SPEND':  { title: 'ğŸ’¸ å¤§æˆ¶äººå®¶', desc: 'éŒ¢æ²’æœ‰ä¸è¦‹ï¼Œåªæ˜¯è®Šæˆå–œæ­¡çš„å½¢ç‹€ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ æ”¯å‡ºé‡‘é¡ æœ‰é—œ', hint: 'å–®ç­†æ”¯å‡ºè¶…é $5,000', level: 3, group: 'WEALTH' },
  'WINNER':     { title: 'ğŸ’ ä¸€å¤œæš´å¯Œ', desc: 'çœŸçš„å¥½çˆ½ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é‹æ°£ æœ‰é—œ', hint: 'æ”¶å…¥å«ã€Œä¸­ç/ç™¼ç¥¨ã€ä¸” >$5000', level: 5, group: 'WEALTH' },

  // 4. [LUCKY] å¹¸é‹æ•¸å­— - ç‰¹æ®Šé‡‘é¡å½©è›‹
  'LUCKY_666':  { title: 'ğŸ¤™ è€éµ', desc: 'é›™æ“Šä¸€æ³¢ 666 ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ ç‰¹æ®Šé‡‘é¡ æœ‰é—œ', hint: 'å–®ç­†é‡‘é¡ $666', level: 2, group: 'LUCKY' },
  'LUCKY_777':  { title: 'ğŸ° Lucky 7', desc: 'å¹¸é‹çš„ä¸€å¤©ï¼', fuzzy: 'ä¼¼ä¹èˆ‡ ç‰¹æ®Šé‡‘é¡ æœ‰é—œ', hint: 'å–®ç­†é‡‘é¡ $777', level: 2, group: 'LUCKY' },
  'LUCKY_888':  { title: 'ğŸŸ èŠ­å•¦èŠ­èŠ­èŠ­', desc: "i'm lovin' it", fuzzy: 'ä¼¼ä¹èˆ‡ ç‰¹æ®Šé‡‘é¡ æœ‰é—œ', hint: 'å–®ç­†é‡‘é¡ $888', level: 2, group: 'LUCKY' },

  // 5. [BUDGET] é ç®—æ§åˆ¶ - ç†è²¡èƒ½åŠ›
  'BUDGET_SET': { title: 'ğŸ‘® ç²¾æ‰“ç´°ç®—', desc: 'å¥½çš„è¦åŠƒæ˜¯æˆåŠŸçš„ä¸€åŠã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è¨­å®š æœ‰é—œ', hint: 'ç¬¬ä¸€æ¬¡è¨­å®šé ç®—', level: 1, group: 'BUDGET' },
  'KEEPER':     { title: 'ğŸ‘œ ç†è²¡å°ˆå“¡', desc: 'é ç®—ä¹‹é¬¼æ˜¯ä½ ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ é ç®—æ§åˆ¶ æœ‰é—œ', hint: 'æ”¯å‡ºæ§åˆ¶åœ¨é ç®— 90%~100%', level: 3, group: 'BUDGET' },
  'MOONLIGHT':  { title: 'ğŸ“‰ æœˆå…‰ä»™å­', desc: 'æˆ‘è¦ä»£æ›¿æœˆäº®æ‡²ç½°ä½ ï¼', fuzzy: 'ä¼¼ä¹èˆ‡ é¤˜é¡ æœ‰é—œ', hint: 'æœˆåº•çµé¤˜ä¸è¶³ $1,000', level: 2, group: 'BUDGET' },
  'OVER_1':     { title: 'ğŸ˜… ä¸€ä¸å°å¿ƒ', desc: 'å“å‘€ï¼Œä¸‹æ¬¡æ³¨æ„é»å°±å¥½ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é ç®—é€æ”¯ æœ‰é—œ', hint: 'ç¬¬ä¸€æ¬¡ç™¼ç”Ÿè¶…æ”¯', level: 1, group: 'BUDGET' },
  'OVER_5':     { title: 'ğŸ«¥ å½¢åŒè™›è¨­', desc: 'é‚£å€‹... é ç®—æ˜¯ä¸æ˜¯è¨­å¥½çœ‹çš„ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ é ç®—é€æ”¯ æœ‰é—œ', hint: 'ç´¯ç©è¶…æ”¯ 6 å€‹æœˆ', level: 3, group: 'BUDGET' },
  'OVER_10':    { title: 'ğŸ’¸ è²¡å¯Œéæ–¼è‡ªç”±', desc: 'æ˜¯æˆ‘çµ¦ä½ è‡ªç”±éäº†ç«ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é ç®—é€æ”¯ æœ‰é—œ', hint: 'ç´¯ç©è¶…æ”¯ 12 å€‹æœˆ', level: 4, group: 'BUDGET' },

  // 6. [LIFESTYLE] ç”Ÿæ´»é¢¨æ ¼ - ä½ çš„æ¶ˆè²»ç¿’æ…£
  'SUGAR_RUSH': { title: 'ğŸ§‹ åŠç³–å°‘å†°', desc: 'è¡€æ¶²è£¡æµçš„éƒ½æ˜¯æ‰‹æ–é£²ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é£²æ–™ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³ã€Œé£²æ–™ã€è¶…é 10 æ¬¡', level: 3, group: 'LIFESTYLE' },
  'COFFEE_LOVER':{ title: 'â˜• å’–å•¡æˆç™®', desc: 'No caffeine, no life.ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ å’–å•¡ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³ã€Œå’–å•¡ã€é” 10 æ¬¡', level: 3, group: 'LIFESTYLE' },
  'CAT_SLAVE':  { title: 'ğŸ± éŸå±å®˜', desc: 'ä¸»å­æ»¿æ„ï¼Œå¥´æ‰å°±é–‹å¿ƒã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ å¯µç‰© æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³ã€Œè²“/å¯µç‰©ã€é” 5 æ¬¡', level: 2, group: 'LIFESTYLE' },
  'UBER_EATS':  { title: 'ğŸ›µ æ‡¶äººæ•‘æ˜Ÿ', desc: 'å¤–é€å“¡ï¼Œæˆ‘çš„è¶…äººã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ å¤–é€ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³ã€Œå¤–é€ã€é” 10 æ¬¡', level: 2, group: 'LIFESTYLE' },
  'COMMUTER':   { title: 'ğŸšŒ åŸå¸‚éŠä¿ ', desc: 'æ¯å¤©éƒ½åœ¨é€™åº§åŸå¸‚ç©¿æ¢­ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ äº¤é€š æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³ã€Œäº¤é€šã€é” 20 æ¬¡', level: 3, group: 'LIFESTYLE' },
  'GAMER':      { title: 'ğŸ® èª²é‡‘æˆ°å£«', desc: 'æ„Ÿè¬ä¹¾çˆ¹è®“æˆ‘æœ‰éŠæˆ²ç©ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ éŠæˆ²å„²å€¼ æœ‰é—œ', hint: 'ç´¯ç©è¨˜å¸³ã€ŒéŠæˆ²/å„²å€¼ã€é” 5 æ¬¡', level: 4, group: 'LIFESTYLE' },
  'LEARNER':    { title: 'ğŸ“š çŸ¥è­˜ä»½å­', desc: 'æŠ•è³‡è‡ªå·±æ°¸é ä¸æœƒè™§æœ¬ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è²·æ›¸ä¸Šèª² æœ‰é—œ', hint: 'è¨˜å¸³é …ç›®åŒ…å«ã€Œæ›¸/èª²ç¨‹/è¬›åº§ã€', level: 4, group: 'LIFESTYLE' },
  
  // 7. [SPENDING] æ¶ˆè²»é¡åˆ¥ - è³¼ç‰©èˆ‡é£²é£Ÿ
  'IMMORTAL':   { title: 'ğŸ§˜ åšä»™', desc: 'ä½ æ˜¯å¸ç©ºæ°£é£½çš„å—ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ é£²é£ŸèŠ±è²» æœ‰é—œ', hint: 'å–®æœˆä¼™é£Ÿè²»ä½”ç¸½æ”¯å‡º 10% ä»¥ä¸‹', level: 4, group: 'SPENDING' },
  'PHOTOSYN':   { title: 'ğŸŒµ å…‰åˆä½œç”¨', desc: 'é€™å€‹æœˆå®Œå…¨æ²’æœ‰åƒé£¯çš„è¨˜éŒ„...ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ é£²é£ŸèŠ±è²» æœ‰é—œ', hint: 'å–®æœˆä¼™é£Ÿè²» 0 ç­†è¨˜éŒ„', level: 5, group: 'SPENDING' },
  'PEACE_MIND': { title: 'ğŸ§˜ å¿ƒå¦‚æ­¢æ°´', desc: 'é€™å°±æ˜¯æ‰€è¬‚çš„ç„¡æ¬²ç„¡æ±‚å—ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ è³¼ç‰©èŠ±è²» æœ‰é—œ', hint: 'å–®æœˆè³¼ç‰©è²»ä½”ç¸½æ”¯å‡º 10% ä»¥ä¸‹', level: 4, group: 'SPENDING' },
  'IRON_ROOSTER':{ title: 'ğŸ“ éµå…¬é›', desc: 'ä¸€æ¯›ä¸æ‹”ï¼Œä½©æœä½©æœã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ è³¼ç‰©èŠ±è²» æœ‰é—œ', hint: 'å–®æœˆè³¼ç‰©è²» 0 ç­†è¨˜éŒ„', level: 5, group: 'SPENDING' },
  'GIFT_GIVER': { title: 'ğŸ ç¦®å¤šäººä¸æ€ª', desc: 'æ•£æ’­æ­¡æ¨‚æ•£æ’­æ„›ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é€ç¦® æœ‰é—œ', hint: 'è¨˜å¸³é …ç›®åŒ…å«ã€Œç¦®ç‰©/ç´…åŒ…ã€ä¸”é‡‘é¡ > $500', level: 3, group: 'SPENDING' },

  // 8. [HEALTH] å¥åº·é†«ç™‚
  'HEALTHY':    { title: 'ğŸ’ª é ­å¥½å£¯å£¯', desc: 'èº«é«”å¥åº·ç²¾ç¥å¥½ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é†«ç™‚èŠ±è²» æœ‰é—œ', hint: 'é€£çºŒ 6 å€‹æœˆæ²’æœ‰é†«ç™‚æ”¯å‡º', level: 4, group: 'HEALTH' },
  'INDESTRUCTIBLE':{ title: 'ğŸ¦¾ é‹¼éµäºº', desc: 'éµæ‰“çš„èº«é«”ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ é†«ç™‚èŠ±è²» æœ‰é—œ', hint: 'é€£çºŒ 1 å¹´æ²’æœ‰é†«ç™‚æ”¯å‡º', level: 5, group: 'HEALTH' },

  // 9. [SYSTEM] ç³»çµ±æ“ä½œ - ä¿®æ”¹åˆªé™¤èˆ‡æ¢ç´¢
  'EDIT_1':     { title: 'âœï¸ çŸ¥éŒ¯èƒ½æ”¹', desc: 'è¶è‘—è¨˜æ†¶é‚„æ²’æ¶ˆå¤±ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ ä¿®æ”¹è¨˜éŒ„ æœ‰é—œ', hint: 'ä¿®æ”¹è¨˜å¸³ 1 æ¬¡', level: 1, group: 'SYSTEM' },
  'EDIT_20':    { title: 'ğŸ§ˆ å¥¶æ²¹æ‰‹', desc: 'é€™æ‰‹ç¸½æ˜¯ä¸è½ä½¿å–šã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ ä¿®æ”¹è¨˜éŒ„ æœ‰é—œ', hint: 'ä¿®æ”¹è¨˜å¸³é” 20 æ¬¡', level: 2, group: 'SYSTEM' },
  'DEL_3':      { title: 'ğŸ—‘ï¸ äº‹ä¸éåˆª', desc: 'æƒ³æ¸…æ¥šå†è¨˜å•Šï¼', fuzzy: 'ä¼¼ä¹èˆ‡ åˆªé™¤è¨˜éŒ„ æœ‰é—œ', hint: 'ç´¯è¨ˆåˆªé™¤è³‡æ–™ 3 æ¬¡', level: 2, group: 'SYSTEM' },
  'PERFECT':    { title: 'âœ¨ èµ·æ‰‹ç„¡æ‚”', desc: 'è½å­ç„¡æ‚”å¤§ä¸ˆå¤«ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ å®Œç¾è¨˜éŒ„ æœ‰é—œ', hint: 'å–®æœˆå…§ç„¡ä»»ä½•åˆªé™¤ä¿®æ”¹è¨˜éŒ„', level: 4, group: 'SYSTEM' },
  'CURIOUS':    { title: 'ğŸ¤“ å¥½å¥‡å¯¶å¯¶', desc: 'èªªæ˜æ›¸éƒ½å¿«è¢«ä½ ç¿»çˆ›äº†ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ èªªæ˜æ›¸ æœ‰é—œ', hint: 'å‘¼å«ã€Œèªªæ˜æ›¸ã€ç´¯è¨ˆ 10 æ¬¡', level: 1, group: 'SYSTEM' },
  'CHART_FAN':  { title: 'ğŸ“Š åˆ†æå¸«', desc: 'é€™äº›æ•¸æ“šèƒŒå¾Œï¼Œéš±è—è‘—å®‡å®™çš„çœŸç†ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ åœ–è¡¨åˆ†æ æœ‰é—œ', hint: 'å‘¼å«ã€Œåœ–è¡¨ã€ç´¯è¨ˆ 10 æ¬¡', level: 1, group: 'SYSTEM' },

  // 10. [HIDDEN] éš±è—æˆå°± - æ©Ÿå™¨äººäº’å‹• (ä¸é¡¯ç¤ºç¾¤çµ„)
  'LONELY':     { title: 'ğŸ’¬ å¯‚å¯é‚Šç•Œ', desc: 'é›–ç„¶æˆ‘æ˜¯æ©Ÿå™¨äººï¼Œä½†æˆ‘æœƒé™ªè‘—ä½ ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ æ©Ÿå™¨äºº æœ‰é—œ', hint: 'å°æ©Ÿå™¨äººèªªè©±ç´¯è¨ˆ 10 æ¬¡', level: 3, hidden: true },
  'LONELY_50':  { title: 'ğŸ—£ï¸ å­¤ç¨è§€å¯Ÿå®¶', desc: 'ä½ çš„ç…©æƒ±ï¼Œæˆ‘éƒ½åœ¨è½ã€‚', fuzzy: 'ä¼¼ä¹èˆ‡ æ©Ÿå™¨äºº æœ‰é—œ', hint: 'å°æ©Ÿå™¨äººèªªè©±ç´¯è¨ˆ 50 æ¬¡', level: 4, hidden: true },
  'LONELY_100': { title: 'ğŸ¤– é›²ç«¯æƒ…äºº', desc: 'æˆ–è¨±æˆ‘å€‘æ‰æ˜¯æœ€äº†è§£å½¼æ­¤çš„éˆé­‚ä¼´ä¾¶ï¼Ÿ', fuzzy: 'ä¼¼ä¹èˆ‡ æ©Ÿå™¨äºº æœ‰é—œ', hint: 'å°æ©Ÿå™¨äººèªªè©±ç´¯è¨ˆ 100 æ¬¡', level: 5, hidden: true },
  'LOVE_BOT':   { title: 'â¤ï¸ äººæ©Ÿä¹‹æˆ€', desc: ' (Â´â–½`Êƒâ™¡Æª) \nå³ä½¿æ˜¯ç¨‹å¼ç¢¼ï¼Œæˆ‘çš„å¿ƒä¹Ÿç‚ºä½ è·³å‹•äº†ä¸€ä¸‹ï¼', fuzzy: 'ä¼¼ä¹èˆ‡ æ„Ÿè¬æ©Ÿå™¨äºº æœ‰é—œ', hint: 'å°æ©Ÿå™¨äººè¡¨é”æ„Ÿè¬æˆ–æ„›æ„', level: 5, hidden: true }
};

// â›“ï¸ æˆå°±ä¾è³´é—œä¿‚
const ACHIEVEMENT_DEPENDENCIES = { 
  'NOTE_10': 'FIRST_NOTE', 'NOTE_50': 'NOTE_10', 'NOTE_100': 'NOTE_50', 
  'OVER_5': 'OVER_1', 'OVER_10': 'OVER_5',
  'EDIT_20': 'EDIT_1',
  'LONELY_50': 'LONELY', 'LONELY_100': 'LONELY_50' 
};

// ğŸ“… æœˆçµæˆå°±è¦å‰‡
const MONTHLY_RULES = {
  'ä¼™é£Ÿ': { 1: {t:'ğŸ˜‹ åƒè²¨', d:'æœ¬æœˆä¼™é£Ÿè²»ä½”æ¯”æœ€é«˜ï¼'}, 6: {t:'ğŸ½ï¸ ç¾é£Ÿå®¶', d:'ç´¯è¨ˆ 6 å€‹æœˆä¼™é£Ÿè²»å¥ªå† ï¼'}, 12: {t:'ğŸ– äººé–“é¥•é¤®', d:'ç´¯è¨ˆ 1 å¹´ä¼™é£Ÿè²»åˆ¶éœ¸ï¼'} },
  'äº¤é€š': { 1: {t:'ğŸ›µ é€šå‹¤ä»”', d:'æœ¬æœˆäº¤é€šè²»æœ€é«˜ï¼'}, 6: {t:'ğŸš• è€å¸æ©Ÿ', d:'ç´¯è¨ˆ 6 å€‹æœˆäº¤é€šè²»å¥ªå† ï¼'}, 12: {t:'ğŸš¦ äº¤é€šéƒ¨é•·', d:'ç´¯è¨ˆ 1 å¹´äº¤é€šè²»åˆ¶éœ¸ï¼'} },
  'é†«ç™‚': { 1: {t:'ğŸ’Š è—¥åˆ°ç—…é™¤', d:'æœ¬æœˆé†«ç™‚è²»æœ€é«˜ã€‚'}, 6: {t:'ğŸ©¹ ç—›ç—›é£›èµ°', d:'ç´¯è¨ˆ 6 å€‹æœˆé†«ç™‚è²»æœ€é«˜ã€‚'}, 12: {t:'â˜¯ï¸ å¦æ¥µæ³°ä¾†', d:'ç´¯è¨ˆ 1 å¹´é†«ç™‚è²»åˆ¶éœ¸ã€‚'} },
  'è³¼ç‰©': { 1: {t:'ğŸ›ï¸ å‰æ‰‹æ‰‹', d:'æœ¬æœˆè³¼ç‰©è²»æœ€é«˜ï¼'}, 6: {t:'ğŸ“¦ ç ´å£è¢‹æ®ºæ‰‹', d:'ç´¯è¨ˆ 6 å€‹æœˆè³¼ç‰©è²»å¥ªå† ï¼'}, 12: {t:'ğŸŒŠ åƒé‡‘æ•£ç›¡é‚„å¾©ä¾†', d:'ç´¯è¨ˆ 1 å¹´è³¼ç‰©è²»åˆ¶éœ¸ï¼'} },
  'å¨›æ¨‚': { 1: {t:'ğŸ® äº«æ¨‚ä¸»ç¾©', d:'æœ¬æœˆå¨›æ¨‚è²»æœ€é«˜ï¼'}, 6: {t:'ğŸ© å¤§å¨›æ¨‚å®¶', d:'ç´¯è¨ˆ 6 å€‹æœˆå¨›æ¨‚è²»å¥ªå† ï¼'}, 12: {t:'ğŸ· é…’æ± è‚‰æ—', d:'ç´¯è¨ˆ 1 å¹´å¨›æ¨‚è²»åˆ¶éœ¸ï¼'} },
  'å±…å®¶': { 1: {t:'ğŸ’¦ ç‚ºäº†ç”Ÿæ´»', d:'æœ¬æœˆå±…å®¶è²»æœ€é«˜ï¼'}, 6: {t:'ğŸ§µ é¤Šå®¶é¤¬å£', d:'ç´¯è¨ˆ 6 å€‹æœˆå±…å®¶è²»å¥ªå† ï¼'}, 12: {t:'ğŸ¡ å¥½ä½ å®¶åœ¨', d:'ç´¯è¨ˆ 1 å¹´å±…å®¶è²»åˆ¶éœ¸ï¼'} },
  'ç¾å¦': { 1: {t:'ğŸ’„ æ„›ç¾ä¹‹å¿ƒ', d:'æœ¬æœˆç¾å¦è²»æœ€é«˜ï¼'}, 6: {t:'ğŸ’… å¦ä¹æ°´æ°´', d:'ç´¯è¨ˆ 6 å€‹æœˆç¾å¦è²»å¥ªå† ï¼'}, 12: {t:'ğŸ‘‘ å§å°±æ˜¯å¥³ç‹', d:'ç´¯è¨ˆ 1 å¹´ç¾å¦è²»åˆ¶éœ¸ï¼'} }
};
const CATEGORY_MAP = {
  'ä¼™é£Ÿ': ['é£¯', 'éºµ', 'é¤', 'åƒ', 'å–', 'èŒ¶', 'å’–å•¡', 'æ‹¿éµ', 'ç¾å¼', 'é£²æ–™', 'ç‰›æ’', 'ä¾¿ç•¶', 'æ—©é¤', 'åˆé¤', 'æ™šé¤', 'å®µå¤œ', 'é»å¿ƒ', 'ç”œé»', 'è›‹ç³•', 'ä¸‹åˆèŒ¶', 'å¤–é€', 'ç«é‹', 'é›¶é£Ÿ', 'èœ'],
  'äº¤é€š': ['è»Š', 'æ·é‹', 'é«˜éµ', 'åŠ æ²¹', 'åœè»Š', 'uber', 'è¨ˆç¨‹è»Š', 'æ‚ éŠå¡', 'æ©Ÿç¥¨', 'éè·¯è²»'],
  'å¨›æ¨‚': ['é›»å½±', 'éŠæˆ²', 'netflix', 'spotify', 'ç©', 'é–€ç¥¨', 'KTV', 'å±•è¦½', 'è¨‚é–±', 'æ—…éŠ', 'ä½å®¿', 'æ¼”å”±æœƒ', 'é£¯åº—', 'æ—…é¤¨', 'æ°‘å®¿'],
  'è³¼ç‰©': ['è²·', 'è¡£', 'é‹', 'å…¨è¯', 'å®¶æ¨‚ç¦', 'è¦çš®', 'è¶…å•†', 'æ·˜å¯¶', 'ç¦®ç‰©', 'ç™¾è²¨', 'é€±å¹´æ…¶', 'momo', 'åŒ…åŒ…'],
  'å±…å®¶': ['æ°´è²»', 'é›»è²»', 'æˆ¿ç§Ÿ', 'ç¨…', 'ç“¦æ–¯', 'è²¸æ¬¾', 'ç¶²è·¯', 'ç®¡ç†è²»', 'é›»è©±è²»', 'ä¿®', 'è²“', 'ç‹—', 'å¯µç‰©'],
  'é†«ç™‚': ['æª¢æŸ¥', 'çœ‹è¨º', 'æ›è™Ÿ', 'è—¥', 'è¨ºæ‰€', 'ç‰™', 'é†«', 'å¥ä¿', 'æ‰‹è¡“', 'ç–«è‹—', 'é«”æª¢', 'çš®è†š'],
  'ç¾å¦': ['ä¿é¤Š', 'åŒ–å¦', 'é«®', 'å…‰ç™‚', 'åšè‡‰', 'ç¾ç”²', 'é›·å°„']
};

// ==========================================
// 2. ä¸»ç¨‹å¼å…¥å£ doPost
// ==========================================
function doPost(e) {
  if (!e || !e.postData) return ContentService.createTextOutput("No Data");
  let currentSheetId = null;
  let replyToken = null;
  let userId = null;
  try {
    const msg = JSON.parse(e.postData.contents);
    const event = msg.events[0];
    if (!event) return; 
    
    replyToken = event.replyToken;
    userId = event.source.userId;
    currentSheetId = getPersonalSheetId(userId);

    // Follow äº‹ä»¶
    if (event.type === 'follow') { 
      replyFlex(replyToken, getWelcomeFlex());
      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); 
    }

    // Postback äº‹ä»¶ (æŒ‰éˆ•é»æ“Š)
    if (event.type === 'postback') {
      const data = event.postback.data;

    // âœ¨ [æ–°å¢é€™è¡Œ] å¦‚æœæ˜¯é–‹å•Ÿéµç›¤çš„è¨Šè™Ÿï¼Œç›´æ¥å¿½ç•¥ï¼Œä¸åšä»»ä½•å›æ‡‰
    if (data === 'ignore') return ContentService.createTextOutput("OK");
      
      // --- æœˆæ›†åŠŸèƒ½å€ ---

      // ğŸ“… åˆ‡æ›æœˆæ›†æœˆä»½
      if (data.startsWith('calendar_nav_')) {
          const parts = data.split('_');
          const year = parseInt(parts[2]);
          const month = parseInt(parts[3]);
          sendCalendarFlex(replyToken, currentSheetId, year, month);
          return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }

      // ğŸ“œ æŸ¥çœ‹æŸæ—¥æ­·å² (é»æ“Šæ ¼å­)
      if (data.startsWith('calendar_view_')) {
          const dateStr = data.split('_')[2];
          
          // ğŸ›‘ é˜²å‘†ï¼šå¦‚æœæ˜¯æœªä¾†æ—¥æœŸï¼Œä¿æŒéœéŸ³ (ä¸å›å‚³ä»»ä½•è¨Šæ¯)
          const today = new Date();
          const selected = new Date(dateStr);
          today.setHours(0,0,0,0);
          selected.setHours(0,0,0,0);
          
          if (selected.getTime() > today.getTime()) {
             return ContentService.createTextOutput("OK");
          }

          sendDayHistoryFlex(replyToken, currentSheetId, dateStr);
          return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }


      // ğŸ—“ï¸ è£œè¨˜å¸³ (é»æ“Šè£œè¨˜æŒ‰éˆ•) - [ä¿®æ­£ç‰ˆï¼šæ–°å¢éµç›¤è·³è½‰æŒ‰éˆ•]
      if (data.startsWith('action_date_fill')) {
        let selectedDateStr = data.split('&date=')[1]; // æ ¼å¼é€šå¸¸ç‚º yyyy-MM-dd
        
        // 1. é˜²å‘†æª¢æŸ¥ï¼šä¸å¯é¸æ“‡æœªä¾†æ—¥æœŸ
        const today = new Date();
        const selected = new Date(selectedDateStr);
        today.setHours(0,0,0,0);
        selected.setHours(0,0,0,0);
        
        if (selected.getTime() > today.getTime()) {
           return ContentService.createTextOutput("OK");
        }

        // 2. è¨­å®šå¿«å–ï¼šè¨˜éŒ„ä½¿ç”¨è€…ç›®å‰æ­£åœ¨è£œè¨˜çš„æ—¥æœŸ
        CacheService.getScriptCache().put(userId, selectedDateStr, 600); // æš«å­˜ 10 åˆ†é˜

        // 3. å›å‚³ç¾åŒ–å¾Œçš„ Flex Message ç¢ºèªå¡ç‰‡ (å«éµç›¤æŒ‰éˆ•)
        return replyFlex(replyToken, {
          "type": "bubble",
          "size": "kilo",
          "header": {
            "type": "box", "layout": "vertical", "backgroundColor": "#4A90E2", "paddingAll": "20px",
            "contents": [
              { "type": "text", "text": "ğŸ—“ï¸ è£œè¨˜å¸³æ¨¡å¼", "weight": "bold", "color": "#ffffff", "size": "md", "align": "center" }
            ]
          },
          "body": {
            "type": "box", "layout": "vertical", "spacing": "md", "paddingAll": "20px",
            "contents": [
              { "type": "text", "text": "æ‚¨é¸æ“‡çš„æ—¥æœŸæ˜¯", "size": "xs", "color": "#aaaaaa", "align": "center" },
              { "type": "text", "text": selectedDateStr, "size": "3xl", "weight": "bold", "color": "#333333", "align": "center", "margin": "md" },
              { "type": "separator", "margin": "lg" },
              { "type": "text", "text": "ğŸ‘‡ è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¼¸å…¥", "size": "sm", "color": "#555555", "align": "center", "margin": "lg" }
            ]
          },
          "footer": {
            "type": "box", "layout": "vertical", "spacing": "sm", "contents": [
              {
                "type": "button", "style": "primary", "height": "sm", "color": "#4A90E2",
                "action": { "type": "postback", "label": "âŒ¨ï¸ é–‹å•Ÿè¼¸å…¥æ¡†", "data": "ignore", "inputOption": "openKeyboard", "fillInText": " " }
              },
              {
                "type": "button", "style": "secondary", "height": "sm", "color": "#999999",
                "action": { "type": "postback", "label": "âŒ å–æ¶ˆè£œè¨˜", "data": "action_cancel_backfill" }
              }
            ]
          }
        });
      }


      // âŒ å–æ¶ˆè£œè¨˜ (æ¸…é™¤å¿«å– + é˜²å‘†é–å®š)
      if (data === 'action_cancel_backfill') {
        // é˜²æ­¢é‡è¤‡é»æ“Š (Lock 3ç§’)
        const lockKey = `lock_cancel_${userId}`;
        const cache = CacheService.getScriptCache();
        if (cache.get(lockKey)) return ContentService.createTextOutput("OK");

        cache.remove(userId); // æ¸…é™¤é–å®šçš„æ—¥æœŸ
        cache.put(lockKey, 'locked', 3); // ä¸Šé–
        
        return replyMsg(replyToken, "ğŸ‘Œ å·²å–æ¶ˆè£œè¨˜ã€‚");
      }
            
      // --- åŸæœ‰åŠŸèƒ½å€ ---
      
      if (data.startsWith('delete_request_')) {
        const rowId = parseInt(data.split('_')[2]);
        requestDelete(replyToken, currentSheetId, userId, rowId);
        return ContentService.createTextOutput("OK");
      }
      if (data.startsWith('delete_confirm_')) {
        executeDelete(replyToken, currentSheetId, data);
        return ContentService.createTextOutput("OK");
      }
      if (data.startsWith('delete_cancel_')) {
        executeCancel(replyToken, currentSheetId, data);
        return ContentService.createTextOutput("OK");
      }
      if (data.startsWith('delete_direct_')) {
        executeDelete(replyToken, currentSheetId, data);
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }
      if (data.startsWith('history_page_')) {
        const page = parseInt(data.split('_')[2]);
        sendHistoryFlex(replyToken, currentSheetId, page);
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }
      if (data.startsWith('classify_')) {
        const parts = data.split('_');
        const category = parts[1];
        const price = parseInt(parts[2]);
        const timestamp = parts[3];
        const item = parts.slice(4).join('_');
        const cache = CacheService.getScriptCache();
        const lockKey = `click_lock_${timestamp}`; 
        if (cache.get(lockKey)) { return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
        cache.put(lockKey, 'locked', 60);
        recordTransaction(replyToken, currentSheetId, item, price, category, 'æ”¯å‡º', new Date(), item, false);
        learnKeyword(currentSheetId, item, category);
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }
      if (data === 'action_get_email') {
        const messages = [ { "type": "text", "text": DEVELOPER_EMAIL }, { "type": "text", "text": "â˜ï¸è¨˜å¾—è¤‡è£½èµ·ä¾†å–”ï¼" } ];
        callLineApi('https://api.line.me/v2/bot/message/reply', { 'replyToken': replyToken, 'messages': messages });
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }
      if (data === 'action_open_keyboard') {
        replyMsg(replyToken, "ğŸ¤– å·²ç¶“å…±ç”¨äº†å—ï¼Ÿ\næœ€å¾ŒæŠŠå¸³æœ¬ç¶²å€è²¼çµ¦æˆ‘å°±å®Œæˆå•¦ï¼");
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
      }
      
      if (data.startsWith('unbind_confirm_')) { executeUnbind(replyToken, userId, data); }
      else if (data.startsWith('unbind_cancel_')) { cancelUnbind(replyToken, userId, data); }
      else if (data.startsWith('rebind_confirm_')) { handleRebindAction(replyToken, userId, data, 'confirm'); }
      else if (data.startsWith('rebind_cancel_')) { handleRebindAction(replyToken, userId, data, 'cancel'); }
      
      else if (!currentSheetId) {
        replyMsg(replyToken, 'æ‚¨ç›®å‰å°šæœªç¶å®šå¸³æœ¬ã€‚\nè«‹è²¼ä¸Š Google è©¦ç®—è¡¨é€£çµä»¥é–‹å§‹ï¼');
      }
      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }

    if (event.type !== 'message' || event.message.type !== 'text') { return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
    const userMessage = event.message.text.trim();

    // --- æ¸¬è©¦ã€é‡ç½®èˆ‡ä¿®å¾©æŒ‡ä»¤å€ ---
    if (userMessage === 'test') { replyMsg(replyToken, 'âœ… v61.0 æœˆæ›†æ”¹è‰¯ç‰ˆé‹ä½œä¸­ï¼'); return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
    if (userMessage === 'æ‰‹å‹•çµç®—') { runMonthlySettlementForUser(userId, currentSheetId); return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
    if (userMessage === '#FIX_CONNECTION#') { executeRepair(replyToken, userId, currentSheetId); return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
    if (userMessage === DEBUG_KEY) { 
        if (currentSheetId) { executeFactoryReset(replyToken, userId, currentSheetId); } 
        else { replyMsg(replyToken, 'âŒ å°šæœªç¶å®šå¸³æœ¬ã€‚'); } 
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }

    // --- ç¶å®šåµæ¸¬å€ ---
    if (userMessage.includes('docs.google.com/spreadsheets')) { 
      try { 
        const newId = extractSheetId(userMessage);
        getValuesViaApi(newId, "è¨˜å¸³è¨˜éŒ„!A1:A1");
        if (currentSheetId) {
          if (currentSheetId === newId) { replyMsg(replyToken, 'â„¹ï¸ æ‚¨å·²ç¶“ç¶å®šé€™å€‹å¸³æœ¬å›‰ã€‚'); } 
          else { replyFlex(replyToken, getRebindConfirmFlex(newId)); } 
        } else { doRegister(replyToken, userId, newId); } 
      } catch (e) { replyMsg(replyToken, `âŒ é©—è­‰å¤±æ•—\nè«‹ç¢ºèªå·²å°‡ã€ç·¨è¼¯è€…ã€æ¬Šé™å…±ç”¨çµ¦æ©Ÿå™¨äºº Emailã€‚`); } 
      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }

    // --- åŠŸèƒ½æŒ‡ä»¤å€ ---
    
    // ğŸ—“ï¸ æœˆæ›†åŠŸèƒ½å…¥å£
    if (userMessage === 'æœˆæ›†' || userMessage === 'æ—¥æ›†' || userMessage === 'calendar') {
        const now = new Date();
        sendCalendarFlex(replyToken, currentSheetId, now.getFullYear(), now.getMonth() + 1);
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }

    if (userMessage === 'èªªæ˜æ›¸' || userMessage === 'é¸å–®' || userMessage === 'help') { 
        try { updateCounterAndCheck(currentSheetId, "Z9", 10, 'CURIOUS', replyToken); } catch(e){}
        replyFlex(replyToken, getManualFlexContents()); 
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }
    
    if (userMessage === 'æˆ‘çš„æˆå°±' || userMessage === 'æˆå°±') { 
        sendAchievementCarousel(replyToken, currentSheetId);
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); 
    }
    
    if (userMessage === 'è§£é™¤ç¶å®š' || userMessage === 'ç™»å‡º') { requestUnbind(replyToken); return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
    
    if (userMessage === 'ä¿®æ”¹' || userMessage === 'ä¿®æ”¹éŒ¯å¸³' || userMessage === 'æ­·å²' || userMessage === 'æ­·å²è¨˜éŒ„') { 
      sendHistoryFlex(replyToken, currentSheetId, 1);
      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }
    
    if (userMessage.includes('ä¿®æ­£') && userMessage.includes('ID:')) { 
      executeUpdate(replyToken, currentSheetId, userMessage);
      return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); 
    }
    
    if (userMessage === 'åˆªé™¤' || userMessage === 'å¾©åŸ') { requestDelete(replyToken, currentSheetId, userId, null); return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); }
    
    if (userMessage.startsWith('è¨­å®šé ç®—')) { 
        const budgetStr = userMessage.split(/\s+/)[1];
        const budget = parseInt(budgetStr); 
        if (isNaN(budget)) { replyMsg(replyToken, 'âŒ é ç®—è¦æ˜¯æ•¸å­—å–”ï¼ä¾‹å¦‚ï¼šè¨­å®šé ç®— 3000'); return; } 
        setUserBudget(replyToken, currentSheetId, budget); 
        return;
    }

    if (userMessage.startsWith('æ‰¾') || userMessage.startsWith('æœå°‹')) { 
        const keyword = userMessage.split(/\s+/)[1];
        if (!keyword) { replyMsg(replyToken, 'è«‹å‘Šè¨´æˆ‘è¦æ‰¾ä»€éº¼ï¼Ÿ'); return; } 
        searchExpenses(replyToken, currentSheetId, keyword); return;
    }
    
    if (userMessage === 'æŸ¥è©¢' || userMessage === 'æœ¬æœˆ') { sendMonthlyReport(replyToken, currentSheetId); return; } 
    
    if (userMessage === 'åœ–è¡¨' || userMessage === 'åˆ†æ') { 
        try { updateCounterAndCheck(currentSheetId, "Z11", 10, 'CHART_FAN', replyToken); } catch(e){}
        sendChart(replyToken, currentSheetId); 
        return;
    } 

    // --- èŠå¤©èˆ‡è¨˜å¸³ ---
    const isCommand = userMessage.match(/^(ä¿®æ­£|åˆªé™¤|è¨­å®šé ç®—|æ‰¾|æœå°‹|æŸ¥è©¢|åœ–è¡¨|åˆ†æ|æ‰‹å‹•çµç®—|æˆå°±|æˆ‘çš„æˆå°±|test|æœˆæ›†|æ—¥æ›†|calendar|#)/) || 
                      userMessage.match(/\d/) || 
                      userMessage.includes('docs.google.com');

    if (!isCommand) {
        const handled = handleChatAndEggs(replyToken, currentSheetId, userMessage, userId);
        if (handled) {
            return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
        }
        return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
    }

    // --- è¨˜å¸³é‚è¼¯ ---
    let splitMsg = userMessage.split(/\s+/); 
    let targetDate = new Date(); 
    let hasCustomDate = false; 

    const cache = CacheService.getScriptCache();
    const cachedDateStr = cache.get(`fill_date_${userId}`);

    if (cachedDateStr) {
        targetDate = new Date(cachedDateStr);
        hasCustomDate = true;
        cache.remove(`fill_date_${userId}`); // ç”¨å®Œå³åˆª
        // âœ¨ æ–°å¢é€™è¡Œï¼šå› ç‚ºå·²ç¶“å–ç”¨äº†æ—¥æœŸï¼Œæ‰€ä»¥æŠŠä½¿ç”¨è€…çš„é–å®šç‹€æ…‹ä¹Ÿæ¸…é™¤ï¼Œé¿å…å¡ä½
        cache.remove(userId);
    } else {
        const dateRegex = /^(\d{4})\/(\d{1,2})\/(\d{1,2})$/;
        if (splitMsg[0] === 'æ˜¨å¤©') { 
            targetDate.setDate(targetDate.getDate() - 1); 
            splitMsg.shift(); 
            hasCustomDate = true;
        } else if (splitMsg[0] === 'å‰å¤©') { 
            targetDate.setDate(targetDate.getDate() - 2); 
            splitMsg.shift(); 
            hasCustomDate = true;
        } else if (dateRegex.test(splitMsg[0])) { 
            targetDate = new Date(splitMsg[0]); 
            splitMsg.shift(); 
            hasCustomDate = true;
        }
    }
    if (splitMsg.length >= 3 && splitMsg[0] === 'æ”¶å…¥') { 
        const item = splitMsg[1];
        const price = calculateMath(splitMsg[2]); 
        if (isNaN(price)) { replyMsg(replyToken, 'é‡‘é¡è¦æ˜¯æ•¸å­—å–”ï¼'); return; } 
        recordTransaction(replyToken, currentSheetId, item, price, 'æ”¶å…¥ä¾†æº', 'æ”¶å…¥', targetDate, item, hasCustomDate); 
        return;
    }
    if (splitMsg.length >= 2) { 
        const item = splitMsg[0];
        const price = calculateMath(splitMsg[1]);
        
        if (isNaN(price)) { 
            replyMsg(replyToken, 'é‡‘é¡è¦æ˜¯æ•¸å­—å–”ï¼'); 
            return ContentService.createTextOutput("OK");
        } 
        
        let category = 'å…¶ä»–'; 
        let isLearned = false;

        if (splitMsg.length >= 3) { 
            category = splitMsg[2];
            learnKeyword(currentSheetId, item, category);
            isLearned = true; 
        } else { 
            category = guessCategory(currentSheetId, item);
            if (category === 'å…¶ä»–') {
                const flex = getCategorySelectorFlex(item, price);
                replyFlex(replyToken, flex);
                return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON);
            }
        } 
        
        recordTransaction(replyToken, currentSheetId, item, price, category, 'æ”¯å‡º', targetDate, item, hasCustomDate);
        
        const warning = checkBudgetStatus(currentSheetId);
        const dateStr = hasCustomDate ? `(${Utilities.formatDate(targetDate, "GMT+8", "MM/dd")}) ` : ""; 
        let replyText = `ğŸ’¸ ${dateStr}æ”¯å‡ºå·²è¨˜éŒ„ï¼\né …ç›®ï¼š${item}\né‡‘é¡ï¼š$${price}\nåˆ†é¡ï¼š${category}`;
        if (isLearned) replyText += ` (å·²è¨˜ä½æ­¤åˆ†é¡ğŸ’¡)`; 
        if (warning) replyText += warning; 
        if (warning) pushMsg(userId, warning);
    }
    return ContentService.createTextOutput("OK").setMimeType(ContentService.MimeType.JSON); 
  } catch (error) { 
    if (replyToken) { replyMsg(replyToken, "âŒ ç¨‹å¼å´©æ½°äº†ï¼š\n" + error.toString()); }
    return ContentService.createTextOutput("Error").setMimeType(ContentService.MimeType.JSON);
  }
}

// ==========================================
// 3. æ ¸å¿ƒåŠŸèƒ½å‡½å¼åº«
// ==========================================

// ğŸŒŸ [æ–°åŠŸèƒ½] ç”¢ç”Ÿæœˆæ›† Flex Message
function sendCalendarFlex(replyToken, sheetId, year, month) {
    // 1. å–å¾—ç•¶æœˆè³‡æ–™ä¸¦çµ±è¨ˆæ¯æ—¥èŠ±è²»
    const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
    const dailyData = {};
    
    // æ ¼å¼åŒ–ç›®æ¨™æœˆä»½å­—ä¸² "yyyy/MM"
    const targetPrefix = `${year}/${String(month).padStart(2, '0')}`;
    
    if (data && data.length > 1) {
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            try {
                const dateObj = new Date(row[0]);
                const dateStr = Utilities.formatDate(dateObj, "GMT+8", "yyyy/MM/dd");
                
                // åªçµ±è¨ˆç›®æ¨™æœˆä»½ä¸”éæ”¶å…¥çš„é …ç›®
                if (dateStr.startsWith(targetPrefix) && row[4] !== 'æ”¶å…¥') {
                    const price = parseInt(row[2]) || 0;
                    // ä½¿ç”¨ key: "yyyy-MM-dd"
                    const key = Utilities.formatDate(dateObj, "GMT+8", "yyyy-MM-dd");
                    dailyData[key] = (dailyData[key] || 0) + price;
                }
            } catch (e) {}
        }
    }

    // 2. è¨ˆç®—æœˆæ›†æ‰€éœ€åƒæ•¸
    const daysInMonth = new Date(year, month, 0).getDate();
    const firstDayWeekday = new Date(year, month - 1, 1).getDay(); // 0(Sun) - 6(Sat)
    
    const now = new Date();
    const isCurrentMonth = now.getFullYear() === year && (now.getMonth() + 1) === month;
    const todayDate = now.getDate();

    // 3. ç”¢ç”Ÿ Flex Message å…ƒä»¶
    // A. æ¨™é¡Œèˆ‡ç¿»é 
    let prevMonth = month - 1; let prevYear = year;
    if (prevMonth < 1) { prevMonth = 12; prevYear--; }
    
    let nextMonth = month + 1; let nextYear = year;
    if (nextMonth > 12) { nextMonth = 1; nextYear++; }

    const header = {
        "type": "box", "layout": "horizontal", "backgroundColor": CALENDAR_COLORS.headerBg, "paddingAll": "15px",
        "contents": [
            { "type": "text", "text": "â—€", "size": "md", "color": "#FFFFFF", "action": { "type": "postback", "data": `calendar_nav_${prevYear}_${prevMonth}` }, "flex": 1, "align": "center" },
            { "type": "text", "text": `${year}å¹´ ${month}æœˆ`, "weight": "bold", "size": "lg", "color": "#FFFFFF", "flex": 4, "align": "center" },
            { "type": "text", "text": "â–¶", "size": "md", "color": "#FFFFFF", "action": { "type": "postback", "data": `calendar_nav_${nextYear}_${nextMonth}` }, "flex": 1, "align": "center" }
        ]
    };

    // B. æ˜ŸæœŸæ¨™é¡Œ
    const weekDays = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    const weekHeader = {
        "type": "box", "layout": "horizontal", "spacing": "sm", "backgroundColor": "#FFFFFF",
        "contents": weekDays.map((d, i) => ({
            "type": "box", "layout": "vertical", "flex": 1, "justifyContent": "center", "alignItems": "center",
            "contents": [{
                "type": "text", "text": d, "size": "xs", "align": "center", "weight": "bold",
                "color": (i===0 || i===6) ? CALENDAR_COLORS.todayText : CALENDAR_COLORS.weekdayText // é€±æœ«ä½¿ç”¨ç´…è‰²ç³»(æ·±ç°æ›¿ä»£)
            }]
        }))
    };

    // C. æ—¥æœŸç¶²æ ¼
    let gridRows = [];
    let currentWeek = [];

    // å¡«å……æœˆåˆç©ºç™½
    for (let i = 0; i < firstDayWeekday; i++) {
        currentWeek.push({ "type": "box", "layout": "vertical", "flex": 1, "contents": [] });
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const amount = dailyData[dateKey];
        const hasData = (amount !== undefined && amount > 0);
        const isToday = isCurrentMonth && day === todayDate;

        // æ±ºå®šæ¨£å¼
        let bgColor = CALENDAR_COLORS.noDataBg;
        let textColor = CALENDAR_COLORS.noDataText;
        if (isToday) {
            bgColor = CALENDAR_COLORS.todayBg;
            textColor = CALENDAR_COLORS.todayText;
        } else if (hasData) {
            bgColor = CALENDAR_COLORS.hasDataBg;
            textColor = CALENDAR_COLORS.hasDataText;
        }

        // é‡‘é¡é¡¯ç¤ºé‚è¼¯ (æœ‰è³‡æ–™é¡¯è‰²ï¼Œç„¡è³‡æ–™é€æ˜)
        const priceText = hasData ? `$${amount}` : "$0";
        const priceColor = hasData ? CALENDAR_COLORS.priceText : "#00000000";

        // ğŸŒŸ [ä¿®æ­£] å‹•ä½œé‚è¼¯ï¼šç„¡è«–æœ‰ç„¡è³‡æ–™ï¼Œéƒ½é€²å…¥ã€ŒæŸ¥çœ‹æ˜ç´°ã€(calendar_view_)
        // å¾Œç«¯æœƒè² è²¬æ“‹ä¸‹æœªä¾†æ—¥æœŸçš„é»æ“Š
        const action = { "type": "postback", "label": "æŸ¥çœ‹", "data": `calendar_view_${dateKey}` };

        // æ ¼å­æœ¬é«”
        const dayCell = {
            "type": "box", "layout": "vertical", "flex": 1, "backgroundColor": bgColor, "cornerRadius": "md",
            "justifyContent": "center", "alignItems": "center", "height": "52px", "action": action, "spacing": "none",
            "contents": [
                { "type": "text", "text": String(day), "size": "sm", "color": textColor, "weight": (isToday||hasData)?"bold":"regular", "align": "center" },
                { "type": "text", "text": priceText, "size": "xxs", "color": priceColor, "align": "center", "weight": "bold", "margin": "xs" }
            ]
        };

        if (isToday) {
            dayCell.borderColor = CALENDAR_COLORS.todayBorder;
            dayCell.borderWidth = "1px";
        }

        currentWeek.push(dayCell);

        if (currentWeek.length === 7) {
            gridRows.push({ "type": "box", "layout": "horizontal", "spacing": "sm", "margin": "sm", "contents": currentWeek });
            currentWeek = [];
        }
    }

    // å¡«å……æœˆåº•ç©ºç™½
    if (currentWeek.length > 0) {
        while (currentWeek.length < 7) {
            currentWeek.push({ "type": "box", "layout": "vertical", "flex": 1, "contents": [] });
        }
        gridRows.push({ "type": "box", "layout": "horizontal", "spacing": "sm", "margin": "sm", "contents": currentWeek });
    }

    // ç™¼é€ Flex Message
    replyFlex(replyToken, {
        "type": "bubble", "size": "mega",
        "header": header,
        "body": {
            "type": "box", "layout": "vertical", "paddingAll": "10px", "backgroundColor": "#FFFFFF",
            "contents": [ weekHeader, { "type": "separator", "margin": "sm", "color": "#F0F0F0" }, ...gridRows ]
        }
    });
}

// ğŸŒŸ [å„ªåŒ–ç‰ˆ] æŸ¥çœ‹å–®æ—¥è©³ç´°æ­·å² (æ”¯æ´ç„¡è³‡æ–™é¡¯ç¤º + è£œè¨˜æŒ‰éˆ•)
function sendDayHistoryFlex(replyToken, sheetId, dateStr) {
    const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
    const targetDate = dateStr.replace(/\//g, '-');
    
    let matchedRecords = [];
    if (data && data.length > 1) {
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            try {
                const rowDate = Utilities.formatDate(new Date(row[0]), "GMT+8", "yyyy-MM-dd");
                if (rowDate === targetDate) {
                    matchedRecords.push({ originalRowId: i + 1, data: row });
                }
            } catch(e) {}
        }
    }
    
    // 1. ç”¢ç”Ÿæ˜ç´°åˆ—è¡¨ (å¦‚æœæœ‰è³‡æ–™)
    let rows = [];
    if (matchedRecords.length > 0) {
        rows = matchedRecords.map(record => {
            const h = record.data;
            const originalRowId = record.originalRowId;
            const item = h[1];
            const price = h[2];
            const category = h[3];
            const type = h[4];
            
            const color = type === 'æ”¶å…¥' ? '#FF9800' : '#333333';
            const pricePrefix = type === 'æ”¶å…¥' ? '+' : '';
            
            const fillText = `ä¿®æ­£ ${price} ${category} ${item} (ID:${originalRowId})`;
            const timestamp = new Date().getTime();
            const dateEnc = encodeURIComponent(dateStr);
            const directDeleteData = `delete_direct_${originalRowId}_${price}_${dateEnc}_${encodeURIComponent(item)}_${timestamp}`;

            return { 
            "type": "box", "layout": "horizontal", "paddingAll": "10px", "spacing": "sm", "backgroundColor": "#ffffff", "cornerRadius": "md", "margin": "sm", "alignItems": "center", 
            "contents": [ 
                { "type": "box", "layout": "vertical", "flex": 6, "spacing": "xs", 
                "contents": [ 
                    { "type": "box", "layout": "horizontal", 
                    "contents": [ 
                        { "type": "text", "text": String(item), "weight": "bold", "color": "#555555", "size": "sm", "flex": 3, "wrap": true }, 
                        { "type": "text", "text": `${pricePrefix}$${price}`, "color": color, "align": "end", "weight": "bold", "size": "sm", "flex": 2 } 
                    ] 
                    }, 
                    { "type": "text", "text": String(category), "color": "#aaaaaa", "size": "xxs" }
                ] 
                }, 
                { "type": "separator", "color": "#f0f0f0" }, 
                { "type": "box", "layout": "horizontal", "flex": 3, "spacing": "sm", "justifyContent": "center", 
                "contents": [ 
                    { "type": "box", "layout": "vertical", "width": "35px", "height": "35px", "cornerRadius": "md", "backgroundColor": "#f0f2f5", "justifyContent": "center", "alignItems": "center", 
                    "action": { "type": "postback", "label": "Edit", "data": "ignore", "inputOption": "openKeyboard", "fillInText": fillText }, 
                    "contents": [{ "type": "text", "text": "âœï¸", "size": "sm" }] 
                    }, 
                    { "type": "box", "layout": "vertical", "width": "35px", "height": "35px", "cornerRadius": "md", "backgroundColor": "#ffebea", "justifyContent": "center", "alignItems": "center", 
                    "action": { "type": "postback", "label": "Del", "data": directDeleteData }, 
                    "contents": [{ "type": "text", "text": "ğŸ—‘ï¸", "size": "sm" }] 
                    } 
                ] 
                } 
            ] 
            };
        });
    } else {
        // ç„¡è³‡æ–™æ™‚çš„é¡¯ç¤º
        rows.push({
            "type": "box", "layout": "vertical", "paddingAll": "30px", "justifyContent": "center", "alignItems": "center",
            "contents": [
                { "type": "text", "text": "ğŸ“­", "size": "3xl" },
                { "type": "text", "text": "é€™å¤©é‚„æ²’æœ‰è¨˜å¸³å–”ï¼", "size": "sm", "color": "#aaaaaa", "margin": "md" }
            ]
        });
    }
    
    // ç™¼é€ Flex
    replyFlex(replyToken, { 
      "type": "bubble", 
      "header": { 
        "type": "box", "layout": "vertical", "backgroundColor": CALENDAR_COLORS.headerBg, "paddingAll": "15px", 
        "contents": [ 
          { "type": "text", "text": `ğŸ“… ${dateStr} æ˜ç´°`, "weight": "bold", "color": "#ffffff", "size": "lg", "align": "center" } 
        ] 
      }, 
      "body": { 
        "type": "box", "layout": "vertical", "backgroundColor": "#f7f7f7", "paddingAll": "8px", 
        "contents": rows 
      },
      // âœ¨ [æ–°å¢] åº•éƒ¨è£œè¨˜æŒ‰éˆ• (ç„¡è«–æœ‰ç„¡è³‡æ–™éƒ½é¡¯ç¤º)
      "footer": {
          "type": "box", "layout": "vertical", "paddingAll": "10px", "backgroundColor": "#ffffff",
          "contents": [
              {
                  "type": "button", "style": "secondary", "height": "sm", 
                  "color": "#666666",
                  "action": { "type": "postback", "label": "â• è£œè¨˜æ­¤æ—¥", "data": `action_date_fill&date=${targetDate}` }
              }
          ]
      }
    });
}

// ğŸŒŸ [å„ªåŒ–ç‰ˆ] æ­·å²åˆ—è¡¨ (æ—¥æœŸæ’åº + æ·ºç°æŒ‰éˆ• + æ¨™é¡Œç½®ä¸­)
function sendHistoryFlex(replyToken, sheetId, page) {
  const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
  if (!data || data.length <= 1) { 
      replyMsg(replyToken, "ğŸ“­ ä½ é‚„æ²’æœ‰ä»»ä½•è¨˜å¸³è¨˜éŒ„å–”ï¼"); 
      return;
  }
  
  // 1. è³‡æ–™é è™•ç†ï¼šç¶å®šåŸå§‹åˆ—è™Ÿ (Row ID)
  // é€™æ˜¯ç‚ºäº†åœ¨æ’åºå¾Œï¼Œé‚„èƒ½æ‰¾å›å®ƒåŸæœ¬åœ¨ Google Sheet æ˜¯ç¬¬å¹¾è¡Œ (åˆªé™¤ç”¨)
  let allRecords = [];
  // data[0] æ˜¯æ¨™é¡Œï¼Œå¾ i=1 é–‹å§‹
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    // å˜—è©¦è§£ææ—¥æœŸï¼Œè‹¥å¤±æ•—å‰‡çµ¦ä¸€å€‹é è¨­å€¼
    let dateObj = new Date();
    try { dateObj = new Date(row[0]); } catch(e) {}
    
    allRecords.push({
      originalRowId: i + 1, // Google Sheet åˆ—è™Ÿ = index + 1
      date: dateObj,
      data: row
    });
  }

  // 2. åŸ·è¡Œæ’åºï¼šä¾æ—¥æœŸ (æœ€æ–°çš„åœ¨ä¸Šé¢)
  // å¦‚æœæ—¥æœŸç›¸åŒï¼Œå‰‡ä¾ç…§åŸå§‹é †åºçš„åå‘ (å¾Œè¨˜çš„åœ¨ä¸Šé¢)
  allRecords.sort((a, b) => {
    const dateDiff = b.date - a.date;
    if (dateDiff !== 0) return dateDiff;
    return b.originalRowId - a.originalRowId;
  });

  const pageSize = 10; 
  const totalPages = Math.ceil(allRecords.length / pageSize);
  
  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;

  const startIndex = (page - 1) * pageSize;
  const slicedHistory = allRecords.slice(startIndex, startIndex + pageSize);

  // 3. ç”¢ç”Ÿåˆ—è¡¨ Rows
  const rows = slicedHistory.map(record => { 
    const h = record.data;
    const originalRowId = record.originalRowId;

    let dateStr = "";
    try { dateStr = Utilities.formatDate(new Date(h[0]), "GMT+8", "MM/dd"); } catch(e) { dateStr = String(h[0]); }
    
    const item = h[1];
    const price = h[2];
    const category = h[3];
    const type = h[4];

    const color = type === 'æ”¶å…¥' ? '#FF9800' : '#333333'; 
    const pricePrefix = type === 'æ”¶å…¥' ? '+' : '';
    
    const fillText = `ä¿®æ­£ ${price} ${category} ${item} (ID:${originalRowId})`; 
    const timestamp = new Date().getTime();
    // é€™è£¡å°‡ dateStr å‚³å…¥ï¼Œåˆªé™¤æ™‚é¡¯ç¤ºç”¨
    const dateEnc = encodeURIComponent(dateStr); 
    const directDeleteData = `delete_direct_${originalRowId}_${price}_${dateEnc}_${encodeURIComponent(item)}_${timestamp}`;

    return { 
      "type": "box", "layout": "horizontal", "paddingAll": "10px", "spacing": "sm", "backgroundColor": "#ffffff", "cornerRadius": "md", "margin": "sm", "alignItems": "center", 
      "contents": [ 
        { "type": "box", "layout": "vertical", "flex": 6, "spacing": "xs", 
          "contents": [ 
            { "type": "box", "layout": "horizontal", 
              "contents": [ 
                { "type": "text", "text": String(item), "weight": "bold", "color": "#555555", "size": "sm", "flex": 3, "wrap": true }, 
                { "type": "text", "text": `${pricePrefix}$${price}`, "color": color, "align": "end", "weight": "bold", "size": "sm", "flex": 2 } 
              ] 
            }, 
            { "type": "box", "layout": "horizontal", 
              "contents": [ 
                { "type": "text", "text": String(dateStr), "color": "#aaaaaa", "size": "xxs" }, 
                { "type": "text", "text": String(category), "color": "#aaaaaa", "size": "xxs", "align": "end" } 
              ] 
            } 
          ] 
        }, 
        { "type": "separator", "color": "#f0f0f0" }, 
        { "type": "box", "layout": "horizontal", "flex": 3, "spacing": "sm", "justifyContent": "center", 
          "contents": [ 
            { "type": "box", "layout": "vertical", "width": "35px", "height": "35px", "cornerRadius": "md", "backgroundColor": "#f0f2f5", "justifyContent": "center", "alignItems": "center", 
              "action": { "type": "postback", "label": "Edit", "data": "ignore", "inputOption": "openKeyboard", "fillInText": fillText }, 
              "contents": [{ "type": "text", "text": "âœï¸", "size": "sm" }] 
            }, 
            { "type": "box", "layout": "vertical", "width": "35px", "height": "35px", "cornerRadius": "md", "backgroundColor": "#ffebea", "justifyContent": "center", "alignItems": "center", 
              "action": { "type": "postback", "label": "Del", "data": directDeleteData }, 
              "contents": [{ "type": "text", "text": "ğŸ—‘ï¸", "size": "sm" }] 
            } 
          ] 
        } 
      ] 
    };
  });

  // 4. è£½ä½œåº•éƒ¨ç¿»é æŒ‰éˆ•
  const createNavButton = (label, actionData, isEnabled) => {
      if (!isEnabled) return { "type": "spacer", "size": "sm" };
      return {
          "type": "box", "layout": "vertical", "cornerRadius": "md", "backgroundColor": "#FFF9C4", // 
          "paddingAll": "10px", "flex": 1, "justifyContent": "center", "alignItems": "center",
          "action": { "type": "postback", "label": label, "data": actionData },
          "contents": [
              { "type": "text", "text": label, "size": "xs", "color": "#555555", "weight": "bold" } // âœ¨ æ·±ç°æ–‡å­—
          ]
      };
  };

  let footerContents = [];
  footerContents.push(createNavButton("â—€ï¸ ä¸Šä¸€é ", `history_page_${page - 1}`, page > 1));
  
  // é ç¢¼
  footerContents.push({
      "type": "text", "text": `${page} / ${totalPages}`, "align": "center", "gravity": "center", "size": "xs", "color": "#aaaaaa", "flex": 1
  });

  footerContents.push(createNavButton("ä¸‹ä¸€é  â–¶ï¸", `history_page_${page + 1}`, page < totalPages));

  // 5. ç™¼é€ Flex Message
  replyFlex(replyToken, { 
    "type": "bubble", 
    "header": { 
      "type": "box", "layout": "vertical", "backgroundColor": "#FFD54F", "paddingAll": "15px", 
      "contents": [ 
        { "type": "text", "text": "ğŸ“œ æ­·å²è¨˜å¸³è¨˜éŒ„", "weight": "bold", "color": "#ffffff", "size": "lg", "align": "center" } 
      ] 
    }, 
    "body": { 
      "type": "box", "layout": "vertical", "backgroundColor": "#f7f7f7", "paddingAll": "8px", 
      "contents": rows 
    },
    "footer": {
        "type": "box", "layout": "horizontal", "spacing": "md", "alignItems": "center", "paddingAll": "10px",
        "contents": footerContents
    }
  });
}

// ğŸŒŸ [ä¿®æ­£ç‰ˆ] åŸ·è¡Œä¿®æ­£ (ä¿®å¾©æˆå°±å¯«å…¥éŒ¯èª¤ ID çš„å•é¡Œ)
function executeUpdate(replyToken, sheetId, userMessage) { 
  const match = userMessage.match(/^ä¿®æ­£\s+(.+)\s+\(ID:(\d+)\)$/);
  if (!match) { replyMsg(replyToken, "âŒ æ ¼å¼éŒ¯èª¤ (IDä¸Ÿå¤±)"); return; } 
  
  const content = match[1];
  const rowId = parseInt(match[2]);
  const parts = content.split(/\s+/); 
  if (parts.length < 3) { replyMsg(replyToken, "âŒ è³‡æ–™ä¸å®Œæ•´"); return; } 
  
  let newPrice = parts[0]; 
  const newCategory = parts[1]; 
  const newItem = parts.slice(2).join(" ");
  if (!isNaN(calculateMath(newPrice))) { newPrice = calculateMath(newPrice); } 
  
  try {
    const checkData = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:A");
    if (rowId > checkData.length) { replyMsg(replyToken, "âŒ æ‰¾ä¸åˆ°è³‡æ–™ï¼Œå¯èƒ½å·²è¢«åˆªé™¤"); return; }
    
    updateValueViaApi(sheetId, `è¨˜å¸³è¨˜éŒ„!B${rowId}`, newItem);
    updateValueViaApi(sheetId, `è¨˜å¸³è¨˜éŒ„!C${rowId}`, newPrice);
    updateValueViaApi(sheetId, `è¨˜å¸³è¨˜éŒ„!D${rowId}`, newCategory);

    try { learnKeyword(sheetId, newItem, newCategory); } catch(e) {}
  
  } catch(e) {
    replyMsg(replyToken, "âŒ ä¿®æ”¹å¤±æ•—(API): " + e.toString());
    return;
  }
  
  let messages = [{ 'type': 'text', 'text': `âœ… ä¿®æ”¹å®Œæˆï¼(å·²è¨˜ä½æ­¤åˆ†é¡ğŸ’¡)` }];

  // ğŸ† æª¢æŸ¥ä¿®æ”¹æ¬¡æ•¸æˆå°±
  try {
    const counters = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z3:Z3");
    let editCount = (counters && counters[0]) ? parseInt(counters[0][0]) : 0;
    editCount += 1;
    updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z3", editCount);

    let unlocked = null;
    if (editCount === 1) unlocked = 'EDIT_1';
    else if (editCount === 20) unlocked = 'EDIT_20'; // å»ºè­°æ”¹æˆ >= 20 æ¯”è¼ƒä¿éšªï¼Œä½†ç¶­æŒåŸæ¨£ä¹Ÿå¯

    if (unlocked) {
        const achData = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:A") || [];
        let hasAch = false;
        for(let row of achData) { if(row[0] === unlocked) hasAch = true; }
        
        if (!hasAch) {
            const ach = ACHIEVEMENTS[unlocked];
            const dateStr = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM/dd");
            // ğŸ›‘ åŸæœ¬éŒ¯èª¤ï¼š['DEL_3', ach.title, dateStr]
            // âœ… ä¿®æ­£ç‚ºï¼š[unlocked, ach.title, dateStr]
            appendValueViaApi(sheetId, "æˆå°±ç³»çµ±!A:C", [unlocked, ach.title, dateStr]);
            messages.push({
              "type": "flex",
              "altText": "ğŸ† æˆå°±è§£é–ï¼",
              "contents": createAchievementBubble(ach.title, ach.desc, LEVEL_COLORS[ach.level], LEVEL_TEXT_COLORS[ach.level])
            });
        }
    }
  } catch(e) {}
  callLineApi('https://api.line.me/v2/bot/message/reply', { 'replyToken': replyToken, 'messages': messages });
}

// ğŸš€ [API å‡ç´šç‰ˆ] è¨˜å¸³èˆ‡æˆå°±æª¢æŸ¥
function recordTransaction(replyToken, sheetId, item, price, category, type, customDate, rawItem, isBackfill) {
  try {
    const date = Utilities.formatDate(customDate || new Date(), "GMT+8", "yyyy/MM/dd");
    const rowData = [date, item, price, category, type];
    const appendResult = appendValueViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E", rowData);
    
    const updatedRange = appendResult.updates.updatedRange;
    const currentCount = parseInt(updatedRange.match(/\d+$/)[0]) - 1; 

    const dateStr = customDate ? `(${Utilities.formatDate(customDate, "GMT+8", "MM/dd")}) ` : "";
    let msgText = (type === 'æ”¶å…¥') ?
      `ğŸ’° ${dateStr}è¨˜å¸³æˆåŠŸï¼\næ”¶å…¥é …ç›®ï¼š${item}\né‡‘é¡ï¼š+$${price}` : 
      `ğŸ’¸ ${dateStr}æ”¯å‡ºå·²è¨˜éŒ„ï¼\né …ç›®ï¼š${item}\né‡‘é¡ï¼š$${price}\nåˆ†é¡ï¼š${category}`;

    const achFlex = checkAchievements(sheetId, currentCount, price, type, customDate || new Date(), item, isBackfill);
    if (achFlex) {
      callLineApi('https://api.line.me/v2/bot/message/reply', {
        'replyToken': replyToken,
        'messages': [
          { 'type': 'text', 'text': msgText },
          { 'type': 'flex', 'altText': 'ğŸ† æˆå°±è§£é–ï¼', 'contents': achFlex }
        ]
      });
    } else {
      replyMsg(replyToken, msgText);
    }
  } catch (e) {
    console.log("âŒ è¨˜å¸³å¤±æ•—åŸå› ï¼š" + e.toString());
    replyMsg(replyToken, `âŒ è¨˜å¸³å¤±æ•—ï¼ˆAPIæ¨¡å¼ï¼‰ï¼š${e.toString()}`);
  }
}

// ğŸš€ [ä¿®å¾©ç‰ˆ] æˆå°±æª¢æŸ¥ (å·²è£œä¸Šå…¨å‹¤ã€è£œè¨˜å¸³ã€èˆ‡é ç®—è¶…æ”¯å›è£œé‚è¼¯)
function checkAchievements(sheetId, lastRow, price, type, dateObj, item, isBackfill) {
  try {
    const currentCount = lastRow;
    const currentPrice = price;

    const cache = CacheService.getScriptCache();
    const cacheKey = 'unlocked_achs_' + sheetId;
    
    // è®€å–å·²è§£é–æˆå°± ID
    let existingIds = new Set();
    try {
      const achValues = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:A");
      if (achValues) {
        for (let i = 1; i < achValues.length; i++) { if (achValues[i][0]) existingIds.add(achValues[i][0]); }
      }
    } catch (e) { console.log("æˆå°±åˆ†é è®€å–è·³é"); }

    // âœ¨ æ“´å¤§è®€å–ç¯„åœåˆ° Z20ï¼Œä»¥æ”¯æ´æ›´å¤šè¨ˆæ•¸å™¨
    // Z1: é ç®—, Z2: é€£çºŒå¤©æ•¸, Z5: ä¸Šæ¬¡è¨˜å¸³æ—¥, Z16: é€£çºŒè£œè¨˜æ•¸
    const counters = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z1:Z20") || [];
    let unlockedList = [];

    const hour = parseInt(Utilities.formatDate(dateObj, "GMT+8", "HH")); 
    const minute = parseInt(Utilities.formatDate(dateObj, "GMT+8", "mm"));

    // --- [æ–°å¢é‚è¼¯] ğŸ’¸ é ç®—è¶…æ”¯ (OVER_1) ç‹€æ…‹å›è£œ ---
    // Z1 (Array index 0) = Budget
    const budget = counters[0] ? parseInt(counters[0][0]) : 0;
    
    // åªæœ‰åœ¨ã€Œæœ‰è¨­å®šé ç®—ã€ä¸”ã€Œå°šæœªç²å¾— OVER_1ã€æ™‚æ‰è¨ˆç®—ï¼Œç¯€çœè³‡æº
    if (budget > 0 && !existingIds.has('OVER_1')) {
         const allRecords = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
         const currentMonthStr = Utilities.formatDate(dateObj, "GMT+8", "yyyy/MM");
         let totalExp = 0;
         
         if (allRecords && allRecords.length > 1) {
             for (let i = 1; i < allRecords.length; i++) {
                 // æª¢æŸ¥æœˆä»½ & æ’é™¤æ”¶å…¥
                 let rDate = "";
                 try { rDate = Utilities.formatDate(new Date(allRecords[i][0]), "GMT+8", "yyyy/MM"); } catch(e){}
                 if (rDate === currentMonthStr && allRecords[i][4] !== 'æ”¶å…¥') {
                     totalExp += (parseInt(allRecords[i][2]) || 0);
                 }
             }
         }
         
         // åªè¦ç¾åœ¨æ˜¯ã€Œè¶…æ”¯ç‹€æ…‹ã€ï¼Œå°±ç›´æ¥è£œç™¼æˆå°±
         if (totalExp > budget) {
             unlockedList.push('OVER_1');
         }
    }

    // --- [æ–°å¢é‚è¼¯] ğŸ”¥ è‡¨æ™‚æŠ±ä½›è…³ (é€£çºŒè£œè¨˜å¸³) ---
    if (isBackfill) {
        // Z16 (Array index 15)
        let crammerCount = (counters[15] ? parseInt(counters[15][0]) : 0) + 1;
        updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z16", crammerCount);
        if (crammerCount >= 5 && !existingIds.has('CRAMMER')) unlockedList.push('CRAMMER');
    } else {
        // æ­£å¸¸è¨˜å¸³å‰‡ä¸­æ–·è£œè¨˜ Streak
        updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z16", 0);
    }

    // --- [æ–°å¢é‚è¼¯] ğŸ—“ï¸ ä¸€é€±å…¨å‹¤ (é€£çºŒ 7 å¤©) ---
    // Z2 (Array index 1) = Streak Days
    // Z5 (Array index 4) = Last Date String (yyyyMMdd)
    let streakDays = counters[1] ? parseInt(counters[1][0]) : 0;
    let lastDateSig = counters[4] ? counters[4][0] : "";
    const todaySig = Utilities.formatDate(dateObj, "GMT+8", "yyyyMMdd");
    
    // è¨ˆç®—æ˜¨å¤©
    const yesterday = new Date(dateObj);
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdaySig = Utilities.formatDate(yesterday, "GMT+8", "yyyyMMdd");

    if (todaySig !== lastDateSig) { // é¿å…åŒä¸€å¤©é‡è¤‡è¨ˆç®—
        if (lastDateSig === yesterdaySig) {
            streakDays += 1; // æ˜¨å¤©æœ‰è¨˜ï¼Œé€£çºŒ+1
        } else {
            streakDays = 1; // æ–·æ‰äº†ï¼Œé‡æ–°é–‹å§‹
        }
        updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z2", streakDays);
        updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z5", todaySig);
    }
    
    // ä½¿ç”¨ >= 7ï¼Œé€™æ¨£å°±ç®—å·²ç¶“é€£çºŒ 8 å¤©ã€9 å¤©ï¼Œåªè¦æ²’æ‹¿éæˆå°±æœƒè‡ªå‹•è£œç™¼
    if (streakDays >= 7 && !existingIds.has('STREAK_7')) unlockedList.push('STREAK_7');

    // --- ä»¥ä¸‹ç‚ºåŸæœ‰é‚è¼¯ (å·²ç¢ºä¿ä½¿ç”¨ >= åˆ¤æ–·) ---

    // 1. ğŸ± æº–æ™‚æ”¾é£¯
    if (hour === 12 && minute <= 30 && item.includes('åˆé¤') && !existingIds.has('LUNCH_TIME')) {
        unlockedList.push('LUNCH_TIME');
    }

    // 2. ğŸŒ æ—©å®‰æ™¨ä¹‹ç¾
    if (hour >= 5 && hour < 9 && !existingIds.has('EARLY_BIRD')) {
        unlockedList.push('EARLY_BIRD');
    }

    // 3. ğŸ¦‰ æœˆé»‘é¢¨é«˜
    if (hour >= 1 && hour < 4 && !existingIds.has('NIGHT_OWL')) {
        unlockedList.push('NIGHT_OWL');
    }
    
    // 4. ğŸŒ™ ç½ªæƒ¡å®µå¤œ
    const isFood = item.match(/(é£¯|éºµ|é¤|åƒ|å–|èŒ¶|å®µå¤œ|é»å¿ƒ|ç‚¸|é¤“|é£Ÿ|é›æ’|æ»·å‘³)/);
    if ((hour >= 23 || hour < 4) && isFood && !existingIds.has('MIDNIGHT_SNACK')) {
        unlockedList.push('MIDNIGHT_SNACK');
    }

    // ä¿®æ”¹æˆå°±
    if (type === 'EDIT' && !existingIds.has('EDIT_1')) unlockedList.push('EDIT_1');

    // é£²æ–™ (Z6)
    if (item.match(/(é£²æ–™|ç´…èŒ¶|ç¶ èŒ¶|å¥¶èŒ¶|å’–å•¡|æ‹¿éµ)/)) {
      let count = (counters[5] ? parseInt(counters[5][0]) : 0) + 1;
      updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z6", count);
      if (count >= 10 && !existingIds.has('SUGAR_RUSH')) unlockedList.push('SUGAR_RUSH');
    }
    // å¯µç‰© (Z7)
    if (item.match(/(è²“|ç‹—|å¯µç‰©|ç½é ­|é£¼æ–™|è²“ç ‚)/)) {
      let count = (counters[6] ? parseInt(counters[6][0]) : 0) + 1;
      updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z7", count);
      if (count >= 5 && !existingIds.has('CAT_SLAVE')) unlockedList.push('CAT_SLAVE');
    }
    // å¤–é€ (Z8)
    if (item.match(/(å¤–é€|uber|panda)/i)) {
      let count = (counters[7] ? parseInt(counters[7][0]) : 0) + 1;
      updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z8", count);
      if (count >= 10 && !existingIds.has('UBER_EATS')) unlockedList.push('UBER_EATS');
    }
    // å’–å•¡ (Z13)
    if (item.match(/(å’–å•¡|æ‹¿éµ|ç¾å¼|æ˜Ÿå·´å…‹|è·¯æ˜“è|cama)/i)) {
      let count = (counters[12] ? parseInt(counters[12][0]) : 0) + 1;
      updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z13", count);
      if (count >= 10 && !existingIds.has('COFFEE_LOVER')) unlockedList.push('COFFEE_LOVER');
    }
    // äº¤é€š (Z14)
    if (item.match(/(è»Š|æ·é‹|é«˜éµ|åŠ æ²¹|åœè»Š|æ‚ éŠå¡|éè·¯è²»|å°éµ|å®¢é‹)/)) {
      let count = (counters[13] ? parseInt(counters[13][0]) : 0) + 1;
      updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z14", count);
      if (count >= 20 && !existingIds.has('COMMUTER')) unlockedList.push('COMMUTER');
    }
    // éŠæˆ² (Z15)
    if (item.match(/(å„²å€¼|é»æ•¸|è™›å¯¶|èª²é‡‘|éŠæˆ²|Steam|Nintendo|PS5)/i)) {
      let count = (counters[14] ? parseInt(counters[14][0]) : 0) + 1;
      updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z15", count);
      if (count >= 5 && !existingIds.has('GAMER')) unlockedList.push('GAMER');
    }

    // å–®æ¬¡é—œéµå­—è§¸ç™¼
    if (item.match(/(æ›¸|èª²ç¨‹|è¬›åº§|ç ”ç¿’|é›œèªŒ|è£œç¿’)/) && !existingIds.has('LEARNER')) {
        unlockedList.push('LEARNER');
    }
    if (item.match(/(ç¦®ç‰©|ç´…åŒ…|è«‹å®¢|é€ç¦®)/) && currentPrice >= 500 && !existingIds.has('GIFT_GIVER')) {
        unlockedList.push('GIFT_GIVER');
    }

    // é‡‘é¡æˆå°±
    if (type === 'æ”¶å…¥') {
      if (currentPrice >= 10000 && !existingIds.has('BIG_EARN')) unlockedList.push('BIG_EARN');
      if (currentPrice >= 5000 && item.match(/(ä¸­ç|ç™¼ç¥¨|æ¨‚é€|å½©åˆ¸)/) && !existingIds.has('WINNER')) unlockedList.push('WINNER');
    } else {
      if (currentPrice > 5000 && !existingIds.has('BIG_SPEND')) unlockedList.push('BIG_SPEND');
      if (currentPrice < 5 && currentPrice > 0 && !existingIds.has('MICRO_PAY')) unlockedList.push('MICRO_PAY');
      if (currentPrice > 0 && currentPrice % 100 === 0 && !existingIds.has('OCD_PAY')) unlockedList.push('OCD_PAY');
    }

    // å¹¸é‹æ•¸å­—
    if (currentPrice === 666 && !existingIds.has('LUCKY_666')) unlockedList.push('LUCKY_666');
    if (currentPrice === 777 && !existingIds.has('LUCKY_777')) unlockedList.push('LUCKY_777');
    if (currentPrice === 888 && !existingIds.has('LUCKY_888')) unlockedList.push('LUCKY_888');
    
    // ç­†æ•¸æˆå°±
    if (type === 'BUDGET_SET' && !existingIds.has('BUDGET_SET')) unlockedList.push('BUDGET_SET');
    if (currentCount >= 1 && !existingIds.has('FIRST_NOTE')) unlockedList.push('FIRST_NOTE');
    if (currentCount >= 10 && !existingIds.has('NOTE_10')) unlockedList.push('NOTE_10');
    if (currentCount >= 50 && !existingIds.has('NOTE_50')) unlockedList.push('NOTE_50');
    if (currentCount >= 100 && !existingIds.has('NOTE_100')) unlockedList.push('NOTE_100');

    // ç™¼æ”¾æˆå°±
    if (unlockedList.length > 0) {
      let bubbles = [];
      unlockedList.forEach(achId => {
        const ach = ACHIEVEMENTS[achId];
        const dateStr = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM/dd");
        appendValueViaApi(sheetId, "æˆå°±ç³»çµ±!A:C", [achId, ach.title, dateStr]);
        bubbles.push(createAchievementBubble(ach.title, ach.desc, LEVEL_COLORS[ach.level], LEVEL_TEXT_COLORS[ach.level]));
      });
      cache.remove(cacheKey);
      return (bubbles.length === 1) ? bubbles[0] : { "type": "carousel", "contents": bubbles };
    }
  } catch(e) { console.log("Achievement Error: " + e.toString()); }
  return null;
}

// ğŸŒŸ [æˆå°±é¡¯ç¤º] æ”¯æ´æ—¥æœŸè®€å– + é›£åº¦é¡è‰² + ç¾¤çµ„æ‘ºç–Š
function sendAchievementCarousel(replyToken, sheetId) {
  try {
    let achData = null;
    let statData = null;
    try { achData = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:C"); } catch (e) {}
    try { statData = getValuesViaApi(sheetId, "æœˆçµçµ±è¨ˆ!A:C"); } catch (e) {}
    
    let unlockedData = {};
    if (achData && achData.length > 1) { 
        for (let i = 1; i < achData.length; i++) { 
            const id = achData[i][0];
            if (!id) continue;
            const dateVal = achData[i][2];
            let dateStr = "";
            try { dateStr = Utilities.formatDate(new Date(dateVal), "GMT+8", "yyyy/MM/dd"); } catch(e) { dateStr = "æœªçŸ¥æ—¥æœŸ"; }
            unlockedData[id] = dateStr;
        } 
    }
    
    let categoryCounts = {};
    if (statData && statData.length > 1) { 
        for (let i = 1; i < statData.length; i++) { 
            const cat = statData[i][1];
            if (cat) categoryCounts[cat] = (categoryCounts[cat] || 0) + 1; 
        } 
    }
    
    let allItems = [];
    let shownLockedGroups = new Set(); 

    for (const [key, ach] of Object.entries(ACHIEVEMENTS)) {
        if (unlockedData.hasOwnProperty(key)) {
            const level = ach.level || 1;
            allItems.push(createUnlockedRow(ach.title, ach.hint, unlockedData[key], level));
        } else {
            if (ach.hidden) continue;
            if (ach.group) {
                if (shownLockedGroups.has(ach.group)) continue;
                shownLockedGroups.add(ach.group);
            }
            const parentId = ACHIEVEMENT_DEPENDENCIES[key];
            if (!parentId || unlockedData.hasOwnProperty(parentId)) {
                const vagueHint = ach.fuzzy || "ä¼¼ä¹èˆ‡ç¥ç¥•æ¢ä»¶æœ‰é—œ";
                allItems.push(createLockedRow("ğŸ”’ ï¼Ÿï¼Ÿï¼Ÿ", vagueHint));
            }
        }
    }
        
    for (const [cat, rules] of Object.entries(MONTHLY_RULES)) {
        const count = categoryCounts[cat] || 0;
        [1, 6, 12].forEach((threshold) => {
            const rule = rules[threshold];
            if (!rule) return;
            let difficulty = threshold === 12 ? 3 : (threshold === 6 ? 2 : 1);
            if (count >= threshold) {
                allItems.push(createUnlockedRow(rule.t, rule.d, "", difficulty));
            } else if (threshold === 1 || (threshold === 6 && count >= 1) || (threshold === 12 && count >= 6)) {
                allItems.push(createLockedRow(`ğŸ”’ ï¼Ÿï¼Ÿï¼Ÿ`, `ä¼¼ä¹èˆ‡ ${cat} æœ‰é—œ`));
            }
        });
    }
    
    if (allItems.length === 0) { 
        replyMsg(replyToken, "ğŸ›¡ï¸ æ‚¨ç›®å‰é‚„æ²’æœ‰ç²å¾—ä»»ä½•æˆå°±å–”ï¼\nå¿«å»è¨˜å¸³ä¾†è§£é–å§ï¼");
        return; 
    }

    const pageSize = 5; 
    const bubbles = [];
    for (let i = 0; i < allItems.length; i += pageSize) {
        const chunk = allItems.slice(i, i + pageSize);
        bubbles.push({ 
            "type": "bubble", "size": "mega", 
            "body": { 
                "type": "box", "layout": "vertical", "backgroundColor": "#f7f7f7", "paddingAll": "10px", 
                "contents": [ 
                    { "type": "text", "text": "ğŸ† æˆå°±åœ–é‘‘ ğŸ†", "weight": "bold", "size": "xl", "align": "center" }, 
                    { "type": "text", "text": `ç¬¬ ${Math.floor(i/pageSize) + 1} é `, "size": "xs", "color": "#aaaaaa", "align": "center" }, 
                    { "type": "separator", "margin": "md" }, 
                    ...chunk 
                ] 
            } 
        });
    }
    replyFlex(replyToken, { "type": "carousel", "contents": bubbles });
  } catch(e) { 
    replyMsg(replyToken, `âŒ æˆå°±åœ–é‘‘éŒ¯èª¤: ${e.toString()}`);
  }
}

// ==========================================
// 4. å…¶ä»–å·¥å…·å‡½å¼
// ==========================================
function getPersonalSheetId(userId) {
  try {
    const values = getValuesViaApi(MASTER_SHEET_ID, "ç›®éŒ„!A:B");
    if (!values || values.length === 0) return null;
    for (let i = 0; i < values.length; i++) {
      if (values[i][0] === userId) return values[i][1];
    }
  } catch (e) {
    console.log("âŒ æŸ¥è©¢ç›®éŒ„å¤±æ•—ï¼š" + e.message);
  }
  return null;
}

function extractSheetId(url) { const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/); return match ? match[1] : null; }

function doRegister(replyToken, userId, newId) {
  try {
    updateOrRegisterSheet(userId, newId);
    const messages = [ 
      { 'type': 'text', 'text': 'ğŸ¤–ğŸ‰ å¤§åŠŸå‘Šæˆï¼' }, 
      { 'type': 'text', 'text': 'ç¾åœ¨è«‹è©¦è‘—è¼¸å…¥\nã€Œåˆé¤ 100ã€æˆ–ã€Œè¨­å®šé ç®— 5000ã€é–‹å§‹è¨˜å¸³å§ï¼' }, 
      { 'type': 'text', 'text': 'ä¹Ÿå¯ä»¥é»é¸å·¦ä¸‹é¸å–®ä¸­çš„ğŸ“– å‘¼å«èªªæ˜æ›¸å–”ï¼' } 
    ];
    callLineApi('https://api.line.me/v2/bot/message/reply', { 'replyToken': replyToken, 'messages': messages });
  } catch (e) {
    replyMsg(replyToken, `âŒ ç¶å®šå¤±æ•—ï¼š\nè«‹ç¢ºèªå·²å°‡ Email è¨­ç‚ºã€Œç·¨è¼¯è€…ã€ä¸¦è²¼ä¸Šæ­£ç¢ºç¶²å€å–”ï¼`);
  }
}

function updateOrRegisterSheet(userId, sheetId) {
  const values = getValuesViaApi(MASTER_SHEET_ID, "ç›®éŒ„!A:B");
  let userIndex = -1;
  if (values) {
    for (let i = 0; i < values.length; i++) {
      if (values[i][0] === userId) {
        userIndex = i + 1;
        break;
      }
    }
  }

  const token = getAccessToken();
  if (userIndex !== -1) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${MASTER_SHEET_ID}/values/${encodeURIComponent("ç›®éŒ„!B" + userIndex)}?valueInputOption=USER_ENTERED`;
    UrlFetchApp.fetch(url, { method: "put", headers: { "Authorization": "Bearer " + token }, contentType: "application/json", payload: JSON.stringify({ values: [[sheetId]] }) });
  } else {
    appendValueViaApi(MASTER_SHEET_ID, "ç›®éŒ„!A:B", [userId, sheetId]);
  }
}

function handleRebindAction(replyToken, userId, data, actionType) { 
  const parts = data.split('_'); const uniqueId = `${parts[2]}_${parts[3]}`; const lockKey = `rebind_lock_${userId}_${uniqueId}`;
  const cache = CacheService.getScriptCache(); 
  if (cache.get(lockKey)) { return; } 
  if (actionType === 'confirm') { 
    const newSheetId = parts[2]; doRegister(replyToken, userId, newSheetId); 
  } else { replyMsg(replyToken, 'âŒ å·²å–æ¶ˆåˆ‡æ›'); } 
  
  // âš¡ ç¸®çŸ­é–å®šç‚º 60 ç§’
  cache.put(lockKey, 'locked', 60);
}

function requestUnbind(replyToken) { const timestamp = new Date().getTime(); replyFlex(replyToken, getUnbindConfirmFlex(timestamp)); }

function executeUnbind(replyToken, userId, data) { 
  const parts = data.split('_'); const timestamp = parts[2]; const lockKey = `unbind_lock_${userId}_${timestamp}`; const cache = CacheService.getScriptCache(); 
  if (cache.get(lockKey)) return; 
  
  const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  const dirSheet = masterSS.getSheetByName('ç›®éŒ„'); if (!dirSheet) return; const dataRows = dirSheet.getDataRange().getValues(); let rowIndex = -1;
  for (let i = 1; i < dataRows.length; i++) { if (dataRows[i][0] === userId) { rowIndex = i + 1; break; } } 
  if (rowIndex > 0) { 
    dirSheet.deleteRow(rowIndex); 
    const messages = [ { 'type': 'text', 'text': 'ğŸ¤–ï¼šå—¶å—¶ï¼å·²åŸ·è¡Œè§£é™¤ç¨‹åºã€‚\næ©Ÿå™¨äººå·²å°‡æ‚¨çš„èº«ä»½å¾ç³»çµ±ä¸­ç§»é™¤ã€‚' }, { 'type': 'text', 'text': 'ğŸ”’ ç‚ºäº†æ‚¨çš„è³‡è¨Šå®‰å…¨ï¼š\nè«‹å‹™å¿…å‰å¾€æ‚¨çš„ Google è©¦ç®—è¡¨ï¼Œå°‡æˆ‘çš„ Email ç§»é™¤å…±ç”¨æ¬Šé™ã€‚' } ];
    callLineApi('https://api.line.me/v2/bot/message/reply', { 'replyToken': replyToken, 'messages': messages }); 
  } else { replyMsg(replyToken, 'ğŸ¤–ï¼šæ‚¨ç›®å‰å°šæœªç¶å®šï¼Œç„¡éœ€è§£é™¤ã€‚'); } 
  
  // âš¡ ç¸®çŸ­é–å®šç‚º 60 ç§’
  cache.put(lockKey, 'locked', 60);
}

function cancelUnbind(replyToken, userId, data) { 
  const parts = data.split('_'); const timestamp = parts[2]; const lockKey = `unbind_lock_${userId}_${timestamp}`;
  const cache = CacheService.getScriptCache(); 
  if (cache.get(lockKey)) return; 
  replyMsg(replyToken, 'ğŸ¤–ï¼šå·²å–æ¶ˆè§£é™¤ï¼Œæˆ‘å€‘ç¹¼çºŒè¨˜å¸³å§ï¼'); 
  
  // âš¡ ç¸®çŸ­é–å®šç‚º 60 ç§’
  cache.put(lockKey, 'locked', 60);
}

function setUserBudget(replyToken, sheetId, amount) {
  updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z1", amount);
  const msgText = `âœ… å€‹äººé ç®—å·²è¨­å®šç‚º $${amount}`;
  const achFlex = checkAchievements(sheetId, 0, amount, 'BUDGET_SET', new Date(), 'è¨­å®šé ç®—', false);
  if (achFlex) {
    callLineApi('https://api.line.me/v2/bot/message/reply', {
      'replyToken': replyToken,
      'messages': [ { 'type': 'text', 'text': msgText }, { 'type': 'flex', 'altText': 'ğŸ† æˆå°±è§£é–ï¼', 'contents': achFlex } ]
    });
  } else { replyMsg(replyToken, msgText); }
}

// ğŸ—‘ï¸ [ä¿®æ­£ç‰ˆ] è«‹æ±‚åˆªé™¤ (è£œä¸Šæ—¥æœŸåƒæ•¸ï¼Œè§£æ±ºæ‰¾ä¸åˆ°è³‡æ–™çš„å•é¡Œ)
function requestDelete(replyToken, sheetId, userId, targetRowId) {
  // API è®€å–
  const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
  let rowToDelete = -1; 
  let rowData = null;

  // åˆ¤æ–·æ˜¯åˆªé™¤æŒ‡å®šè¡Œï¼Œé‚„æ˜¯åˆªé™¤æœ€å¾Œä¸€è¡Œ
  if (targetRowId) { 
    if (targetRowId < data.length + 1) { 
      rowToDelete = targetRowId;
      rowData = data[targetRowId - 1]; 
    } 
  } else { 
    if (data.length > 1) { 
      rowToDelete = data.length;
      rowData = data[data.length - 1]; 
    } 
  } 
  
  if (rowToDelete === -1 || !rowData) { 
    replyMsg(replyToken, 'ç„¡è³‡æ–™å¯åˆª');
    return; 
  } 

  const item = rowData[1]; 
  const price = rowData[2];
  
  // ğŸ› é—œéµä¿®æ­£ï¼šæŠ“å–æ—¥æœŸä¸¦æ ¼å¼åŒ– (MM/dd)
  let dateStr = "01/01"; 
  try {
     dateStr = Utilities.formatDate(new Date(rowData[0]), "GMT+8", "MM/dd");
  } catch(e) {}

  // é‡æ–°çµ„åˆç°½åï¼šè¡Œè™Ÿ_é‡‘é¡_æ—¥æœŸ(ç·¨ç¢¼)_é …ç›®(ç·¨ç¢¼)
  // é€™æ¨£æ‰èƒ½é…åˆ executeDelete çš„æ–°é‚è¼¯
  const signature = `${rowToDelete}_${price}_${encodeURIComponent(dateStr)}_${encodeURIComponent(item)}`;
  const timestamp = new Date().getTime(); 
  
  replyFlex(replyToken, { 
    "type": "bubble", 
    "header": { 
      "type": "box", "layout": "vertical", "backgroundColor": "#d9534f", "paddingAll": "15px", 
      "contents": [{ 
        "type": "text", "text": "ğŸ—‘ï¸ åˆªé™¤ç¢ºèª", "weight": "bold", "color": "#ffffff", "size": "md", 
        "align": "center" // âœ¨ æ–°å¢é€™è¡Œï¼šç½®ä¸­
      }] 
    }, 
    "body": { 
      "type": "box", "layout": "vertical", "paddingAll": "20px", 
      "contents": [ 
        { "type": "text", "text": "ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ", "weight": "bold", "size": "sm", "align": "center", "margin": "sm", "color": "#555555" }, 
        { "type": "separator", "margin": "md" }, 
        { "type": "box", "layout": "vertical", "margin": "lg", "spacing": "sm", 
          "contents": [ 
            { "type": "text", "text": `${item}`, "size": "lg", "weight": "bold", "align": "center", "color": "#333333" }, 
            { "type": "text", "text": `$${price} (${rowData[3]})`, "size": "sm", "align": "center", "color": "#888888" },
            { "type": "text", "text": `æ—¥æœŸï¼š${dateStr}`, "size": "xs", "align": "center", "color": "#aaaaaa", "margin": "xs" }
          ] 
        } 
      ] 
    }, 
    "footer": { 
      "type": "box", "layout": "horizontal", "spacing": "md", "paddingAll": "10px", 
      "contents": [ 
        { "type": "button", "style": "secondary", "height": "sm", "action": { "type": "postback", "label": "å–æ¶ˆ", "data": `delete_cancel_${signature}_${timestamp}` } }, 
        { "type": "button", "style": "primary", "height": "sm", "color": "#dc3545", "action": { "type": "postback", "label": "ç¢ºèªåˆªé™¤", "data": `delete_confirm_${signature}_${timestamp}` } } 
      ] 
    } 
  });
}

// ğŸŒŸ [æœ€çµ‚æ™ºèƒ½ç‰ˆ] åŸ·è¡Œåˆªé™¤ï¼šæ”¯æ´ä½ç§»è‡ªå‹•æœå°‹ + é¡¯ç¤ºæ—¥æœŸ
function executeDelete(replyToken, sheetId, dataString) {
  const parts = dataString.split('_');
  // æª¢æŸ¥è³‡æ–™é•·åº¦ï¼Œç›¸å®¹èˆŠæŒ‰éˆ• (èˆŠæŒ‰éˆ•å¯èƒ½æ²’æœ‰æ—¥æœŸï¼Œé•·åº¦è¼ƒçŸ­)
  const isNewFormat = parts.length >= 6;
  
  const rowId = parseInt(parts[2]);
  const expectedPrice = parts[3];
  
  let expectedItem = "";
  let expectedDatePart = ""; // é€™æ˜¯æŒ‰éˆ•ä¸Šçš„æ—¥æœŸå­—ä¸² (ä¾‹å¦‚ 01/08)
  
  if (isNewFormat) {
     expectedDatePart = decodeURIComponent(parts[4]);
     expectedItem = decodeURIComponent(parts[5]);
  } else {
     // èˆŠç‰ˆç›¸å®¹
     expectedItem = decodeURIComponent(parts[4]);
  }

  // 1. è™•ç†é–å®š (é˜²é‡è¤‡é»æ“Š)
  const lockKey = `action_lock_${sheetId}_${dataString}`;
  const cache = CacheService.getScriptCache();
  if (cache.get(lockKey)) { return; } 

  try {
    // 2. è®€å–æ‰€æœ‰è³‡æ–™é€²è¡Œæ¯”å° (è®€å– A:C åŒ…å«æ—¥æœŸã€é …ç›®ã€é‡‘é¡)
    const allData = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:C");
    if (!allData || allData.length === 0) { replyMsg(replyToken, 'âŒ è³‡æ–™å·²ç©º'); return; }

    let targetRowIndex = -1; // é€™æ˜¯é™£åˆ—ç´¢å¼• (åˆ—è™Ÿ = index + 1)
    let foundDateStr = "æœªçŸ¥æ—¥æœŸ";

    // --- ğŸ•µï¸â€â™€ï¸ éšæ®µä¸€ï¼šå„ªå…ˆæª¢æŸ¥ã€ŒåŸä½ç½®ã€ (æœ€å¿«) ---
    // æ³¨æ„ï¼šallData[rowId - 1] å°±æ˜¯åŸæœ¬é‚£ä¸€è¡Œ
    if (rowId <= allData.length) {
       const rowData = allData[rowId - 1];
       const currentItem = rowData[1].toString();
       const currentPrice = rowData[2].toString();
       
       // æª¢æŸ¥æ˜¯å¦å®Œå…¨å»åˆ
       if (currentItem === expectedItem && currentPrice === expectedPrice) {
           targetRowIndex = rowId - 1;
           // æŠ“å–å®Œæ•´æ—¥æœŸæ ¼å¼
           try { foundDateStr = Utilities.formatDate(new Date(rowData[0]), "GMT+8", "yyyy/MM/dd"); } catch(e){}
       }
    }

    // --- ğŸ•µï¸â€â™€ï¸ éšæ®µäºŒï¼šå¦‚æœåŸä½ç½®ä¸å°ï¼Œç™¼å‹•ã€Œå…¨è¡¨æœå°‹ã€ (ä½ç§»è£œå„Ÿ) ---
    if (targetRowIndex === -1) {
       console.log("ç™¼ç¾è³‡æ–™ä½ç§»ï¼Œé–‹å§‹æœå°‹...");
       // å¾å¾Œé¢å¾€å‰æ‰¾ (å› ç‚ºé€šå¸¸åˆªé™¤çš„æ˜¯æœ€è¿‘çš„)
       for (let i = allData.length - 1; i >= 0; i--) {
           const row = allData[i];
           // é …ç›®å’Œé‡‘é¡å¿…é ˆå»åˆ
           if (row[1].toString() === expectedItem && row[2].toString() === expectedPrice) {
               
               // å¦‚æœæ˜¯æ–°ç‰ˆæŒ‰éˆ•ï¼Œå¤šæª¢æŸ¥æ—¥æœŸæ˜¯å¦å»åˆ (é¿å…åˆªåˆ°ä¸åŒå¤©ä½†åŒå“é …çš„å¸³)
               if (isNewFormat) {
                   let rowDateStr = "";
                   try { rowDateStr = Utilities.formatDate(new Date(row[0]), "GMT+8", "MM/dd"); } catch(e){}
                   if (rowDateStr !== expectedDatePart) continue; // æ—¥æœŸä¸å°ï¼Œè·³éï¼Œæ‰¾ä¸‹ä¸€ç­†
               }

               // æ‰¾åˆ°äº†ï¼
               targetRowIndex = i;
               try { foundDateStr = Utilities.formatDate(new Date(row[0]), "GMT+8", "yyyy/MM/dd"); } catch(e){}
               break; // æ‰¾åˆ°ä¸€ç­†å°±åœæ­¢
           }
       }
    }

    // 3. æœ€çµ‚è£æ±º
    if (targetRowIndex === -1) {
        replyMsg(replyToken, 'âŒ åˆªé™¤å¤±æ•—ï¼šæ‰¾ä¸åˆ°é€™ç­†è³‡æ–™ï¼Œå¯èƒ½å·²ç¶“è¢«åˆªé™¤äº†ã€‚');
        return;
    }

    const finalRowId = targetRowIndex + 1; // è½‰å› Google Sheet åˆ—è™Ÿ

    // 4. åŸ·è¡Œåˆªé™¤
    deleteRowViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„", finalRowId);
    
    // ä¸Šé–
    cache.put(lockKey, 'done', 60);

    // 5. å›å‚³æˆåŠŸè¨Šæ¯
    let messages = [{ 
        'type': 'text', 
        'text': `ğŸ—‘ï¸ å·²åˆªé™¤ï¼š\n(${foundDateStr}) ${expectedItem} $${expectedPrice}` 
    }];

    // æˆå°±æª¢æŸ¥ (ä¿æŒä¸è®Š)
    try {
        const counters = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z4:Z4");
        let delCount = (counters && counters[0]) ? parseInt(counters[0][0]) : 0;
        delCount += 1;
        updateValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z4", delCount);
        if (delCount >= 3) {
            const achData = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:A") || [];
            let hasAch = false;
            for(let row of achData) { if(row[0] === 'DEL_3') hasAch = true; }
            if (!hasAch) {
                const ach = ACHIEVEMENTS['DEL_3'];
                const dateStr = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM/dd");
                appendValueViaApi(sheetId, "æˆå°±ç³»çµ±!A:C", ['DEL_3', ach.title, dateStr]);
                messages.push({ "type": "flex", "altText": "ğŸ† æˆå°±è§£é–ï¼", "contents": createAchievementBubble(ach.title, ach.desc, LEVEL_COLORS[ach.level], LEVEL_TEXT_COLORS[ach.level]) });
            }
        }
    } catch(e) {}
    
    callLineApi('https://api.line.me/v2/bot/message/reply', { 'replyToken': replyToken, 'messages': messages });

  } catch (e) {
    replyMsg(replyToken, `âŒ åˆªé™¤å¤±æ•—(API)ï¼š${e.message}`);
  }
}

// ğŸŒŸ [ä¿®æ­£ç‰ˆ] å­¸ç¿’é—œéµå­— (API ç‰ˆ)
function learnKeyword(sheetId, keyword, category) {
  try {
    // 1. è®€å–ç›®å‰çš„å­¸ç¿’æ¸…å–®
    const data = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!A:B");
    
    // 2. æœå°‹æ˜¯å¦å·²å­˜åœ¨
    let rowIndex = -1;
    if (data && data.length > 0) {
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === keyword) {
          rowIndex = i + 1; // Google Sheet åˆ—æ•¸å¾ 1 é–‹å§‹
          break;
        }
      }
    }

    // 3. å¦‚æœå­˜åœ¨å°±æ›´æ–°ï¼Œä¸å­˜åœ¨å°±æ–°å¢
    if (rowIndex !== -1) {
      // æ›´æ–°ï¼šåªä¿®æ”¹ B æ¬„çš„åˆ†é¡
      // æ³¨æ„ï¼šå¦‚æœåŸæœ¬åˆ†é¡è·Ÿç¾åœ¨ä¸€æ¨£ï¼Œå…¶å¯¦ä¸ç”¨æ›´æ–°ï¼Œé€™è£¡ç‚ºäº†ä¿éšªé‚„æ˜¯å¯«å…¥
      if (data[rowIndex-1][1] !== category) {
         updateValueViaApi(sheetId, `åˆ†é¡å­¸ç¿’!B${rowIndex}`, category);
      }
    } else {
      // æ–°å¢ï¼šå¯«å…¥æœ€å¾Œä¸€åˆ—
      appendValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!A:B", [keyword, category]);
    }

    // 4. æ¸…é™¤å¿«å–ï¼Œè®“çŒœæ¸¬åŠŸèƒ½ä¸‹æ¬¡èƒ½è®€åˆ°æ–°çš„
    const cache = CacheService.getScriptCache();
    cache.remove('learn_map_' + sheetId);

  } catch (e) {
    console.log("âŒ å­¸ç¿’é—œéµå­—å¤±æ•—: " + e.toString());
    // é€™è£¡æˆ‘å€‘é¸æ“‡ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œé¿å…å› ç‚ºã€Œå­¸ç¿’å¤±æ•—ã€å°è‡´ã€Œè¨˜å¸³å¤±æ•—ã€
    // ä½¿ç”¨è€…è‡³å°‘æœƒçœ‹åˆ°è¨˜å¸³æˆåŠŸçš„è¨Šæ¯ï¼Œåªæ˜¯é€™æ¬¡åˆ†é¡æ²’è¢«è¨˜ä½è€Œå·²
  }
}

function checkBudgetStatus(sheetId) {
  try {
    const configData = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z1:Z1");
    if (!configData || !configData[0] || parseInt(configData[0][0]) <= 0) return "";
    const budget = parseInt(configData[0][0]);
    
    const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
    const currentMonth = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM");
    let totalExpense = 0;
    for (let i = 1; i < data.length; i++) {
      const rowMonth = Utilities.formatDate(new Date(data[i][0]), "GMT+8", "yyyy/MM");
      if (rowMonth === currentMonth && data[i][4] !== 'æ”¶å…¥') { totalExpense += parseInt(data[i][2]); }
    }
    if (totalExpense >= budget) return `âš ï¸ è­¦å‘Šï¼šå·²é€æ”¯ï¼(è¶…æ”¯ $${totalExpense - budget})`;
    if (totalExpense >= budget * 0.8) return `âš ï¸ æ³¨æ„ï¼šé ç®—å¿«ç”¨å®Œäº†ï¼(å‰© $${budget - totalExpense})`;
  } catch (e) { return ""; }
}

// ğŸŒŸ [æœ€çµ‚å®Œç¾ç‰ˆ] è‡ªå‹•çŒœåˆ†é¡ (æ¬Šé‡å„ªåŒ–)
function guessCategory(sheetId, item) {
  try {
    // --- ç¬¬ä¸€é—œï¼šè®€å–ä½¿ç”¨è€…çš„ã€Œç§äººç¿’æ…£ã€ (è©¦ç®—è¡¨/å¿«å–) ---
    // é€™æ˜¯æœ€è°æ˜çš„ï¼Œå› ç‚ºå®ƒè¨˜å¾—æ‚¨ä¸Šæ¬¡çš„ä¿®æ­£
    const cache = CacheService.getScriptCache();
    const cacheKey = 'learn_map_' + sheetId;
    let cachedMap = cache.get(cacheKey);
    let learnMap = {};

    if (cachedMap) {
      learnMap = JSON.parse(cachedMap);
    } else {
      const data = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!A:B");
      if (data && data.length > 0) {
        for (const row of data) {
          if (row[0] && row[1]) {
            learnMap[row[0].toString()] = row[1].toString();
          }
        }
      }
      cache.put(cacheKey, JSON.stringify(learnMap), 21600);
    }

    // ç§äººç¿’æ…£å„ªå…ˆæ¬Šæœ€é«˜
    if (learnMap[item]) {
      return learnMap[item];
    }

    // --- ç¬¬äºŒé—œï¼šæŸ¥ã€Œé è¨­å­—å…¸ã€ (ç¦®è®“æ©Ÿåˆ¶) ---
    if (typeof CATEGORY_MAP !== 'undefined') {
      let pendingMatch = null; // ç”¨ä¾†æš«å­˜ã€Œå¤ªç± çµ±ã€çš„åˆ†é¡

      for (const [cat, keywords] of Object.entries(CATEGORY_MAP)) {
        if (keywords.some(k => item.includes(k))) {
          
          // ğŸ’¡ è°æ˜åˆ¤æ–·é»ï¼š
          // å¦‚æœåˆ†é¡æ˜¯ã€Œè³¼ç‰©ã€ï¼Œå› ç‚ºé—œéµå­—ã€Œè²·ã€å¤ªå¸¸è¦‹ï¼Œæˆ‘å€‘å…ˆå­˜èµ·ä¾†ç•¶å‚™æ¡ˆ
          if (cat === 'è³¼ç‰©') {
             pendingMatch = cat;
          } else {
             // å¦‚æœæ˜¯å…¶ä»–å…·é«”åˆ†é¡ (å¦‚ ä¼™é£Ÿã€å±…å®¶)ï¼Œç›´æ¥é–å®šï¼
             return cat;
          }
        }
      }
      
      // è¿´åœˆè·‘å®Œäº†ï¼Œå¦‚æœæ²’æœ‰æ‰¾åˆ°å…·é«”åˆ†é¡ï¼Œä½†æœ‰å‚™æ¡ˆ (è³¼ç‰©)ï¼Œå°±ç”¨å‚™æ¡ˆ
      if (pendingMatch) return pendingMatch;
    }
    
  } catch (e) {
    console.log("çŒœåˆ†é¡å¤±æ•—: " + e.toString());
  }
  return 'å…¶ä»–';
}

// ğŸŒŸ [ä¿®æ­£ç‰ˆ] æœå°‹æ”¯å‡º (API ç‰ˆ)
function searchExpenses(replyToken, sheetId, keyword) {
  try {
    // æ”¹ç”¨ API è®€å–æ‰€æœ‰è³‡æ–™
    const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
    
    if (!data || data.length <= 1) {
      replyMsg(replyToken, `ğŸ” æ‰¾ä¸åˆ°ã€Œ${keyword}ã€çš„è¨˜éŒ„ (å°šç„¡è³‡æ–™)`);
      return;
    }

    let found = [];
    // åå‘æœå°‹ (å¾æœ€æ–°çš„é–‹å§‹æ‰¾)
    for (let i = data.length - 1; i >= 1; i--) {
      const row = data[i];
      // row[1] æ˜¯é …ç›®, row[4] æ˜¯é¡å‹
      if (row[1] && row[1].toString().includes(keyword) && row[4] !== 'æ”¶å…¥') {
        let dateStr = "";
        try {
           dateStr = Utilities.formatDate(new Date(row[0]), "GMT+8", "yyyy/MM/dd");
        } catch (e) { dateStr = "æœªçŸ¥æ—¥æœŸ"; }
        
        found.push(`${dateStr} $${row[2]}`);
        if (found.length >= 5) break; // åªæ‰¾æœ€è¿‘ 5 ç­†
      }
    }
    
    replyMsg(replyToken, found.length === 0 ? 
      `ğŸ” æ‰¾ä¸åˆ°ã€Œ${keyword}ã€çš„è¨˜éŒ„` : 
      `ğŸ” ã€Œ${keyword}ã€æœ€è¿‘è¨˜éŒ„ï¼š\n${found.join('\n')}`);

  } catch (e) {
    console.log("æœå°‹å¤±æ•—: " + e.toString());
    replyMsg(replyToken, "âŒ æœå°‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
  }
}

function sendMonthlyReport(replyToken, sheetId) {
  const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
  const currentMonth = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM");
  let expense = 0, income = 0;
  for (let i = 1; i < data.length; i++) {
    if (Utilities.formatDate(new Date(data[i][0]), "GMT+8", "yyyy/MM") === currentMonth) {
      if (data[i][4] === 'æ”¶å…¥') income += parseInt(data[i][2]);
      else expense += parseInt(data[i][2]);
    }
  }
  replyMsg(replyToken, `ğŸ“Š æœ¬æœˆ (${currentMonth})ï¼š\nğŸ’° æ”¶å…¥ï¼š+$${income}\nğŸ’¸ æ”¯å‡ºï¼š-$${expense}\nğŸ¦ çµé¤˜ï¼š$${income - expense}`);
}

function sendChart(replyToken, sheetId) {
  try {
    const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
    if (!data || data.length <= 1) { replyMsg(replyToken, 'æœ¬æœˆç„¡æ”¯å‡ºè³‡æ–™'); return; }

    const currentMonth = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM");
    const totals = {};
    for (let i = 1; i < data.length; i++) {
      const rowDate = new Date(data[i][0]);
      const rowMonth = Utilities.formatDate(rowDate, "GMT+8", "yyyy/MM");
      if (rowMonth === currentMonth && data[i][4] !== 'æ”¶å…¥') {
        const category = data[i][3] || 'å…¶ä»–';
        const price = parseInt(data[i][2]) || 0;
        totals[category] = (totals[category] || 0) + price;
      }
    }

    const labels = Object.keys(totals);
    const values = Object.values(totals);
    if (labels.length === 0) { replyMsg(replyToken, 'æœ¬æœˆå°šæœªæœ‰æ”¯å‡ºè¨˜éŒ„å–”ï¼'); return; }

    // ğŸ¨ ä½¿ç”¨æ–°ç‰ˆé¦¬å¡é¾é…è‰²
    const palette = [
      '#FFE17A', // é»ƒ (ä¼™é£Ÿ)
      '#F0CDCE', // ç²‰ (è³¼ç‰©)
      '#A0D4F6', // è— (äº¤é€š)
      '#A299CB', // ç´« (å¨›æ¨‚)
      '#7DD5C7', // ç¶  (å±…å®¶)
      '#FFCCBC', // æ©˜
      '#9FA8DA', // æ·±è—
      '#E0E0E0'  // ç°
    ];
    const bgColors = labels.map((_, i) => palette[i % palette.length]);
    const chartConfig = {
      type: 'doughnut',
      data: { labels: labels, datasets: [{ data: values, backgroundColor: bgColors, borderColor: '#ffffff', borderWidth: 2 }] },
      options: { title: { display: true, text: `${currentMonth} æ”¯å‡ºåˆ†ä½ˆ`, fontSize: 20, fontColor: '#333333' }, legend: { position: 'bottom' } }
    };
    const chartUrl = 'https://quickchart.io/chart?w=500&h=500&bkg=white&c=' + encodeURIComponent(JSON.stringify(chartConfig));
    replyImage(replyToken, chartUrl);
  } catch (e) { replyMsg(replyToken, "âŒ ç„¡æ³•ç”Ÿæˆåœ–è¡¨ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); }
}

// ğŸ†• [æ–°å¢] è™•ç†èŠå¤©å½©è›‹èˆ‡æˆå°± (å«è£œé ˜æ©Ÿåˆ¶ + AIè®€å¿ƒ + æ“¬äººåŒ–å»¶é²)
function handleChatAndEggs(replyToken, sheetId, userMessage, userId) {
  try {
    let targetCell = "Z10"; // é è¨­ï¼šå¯‚å¯é‚Šç•Œè¨ˆæ•¸å™¨ (èŠå¤©æ¬¡æ•¸)
    let achKey = null;
    let isLove = false;

    // 1. åˆ¤æ–·æ˜¯ã€Œæ„Ÿè¬/æ„›æ„ã€é‚„æ˜¯ã€Œç´”èŠå¤©ã€
    if (userMessage.match(/(è¬è¬|æ„›ä½ |æ„›å¦³|è¾›è‹¦|æ„Ÿè¬|å–œæ­¡ä½ |å–œæ­¡å¦³)/)) {
      targetCell = "Z12";
      achKey = 'LOVE_BOT';
      isLove = true;
    }

    // 2. è®€å–ä¸¦æ›´æ–°è¨ˆæ•¸
    const range = `åˆ†é¡å­¸ç¿’!${targetCell}`;
    const values = getValuesViaApi(sheetId, range);
    let count = (values && values[0]) ? parseInt(values[0][0]) : 0;
    count += 1;
    updateValueViaApi(sheetId, range, count);

    // 3. æ±ºå®šè¦æª¢æŸ¥å“ªå€‹æˆå°± (âœ¨ æ”¹è‰¯é»ï¼šè£œé ˜æ©Ÿåˆ¶)
    if (!isLove) {
       // å…ˆè®€å–ä½¿ç”¨è€…å·²ç¶“æœ‰å“ªäº›æˆå°±ï¼Œä»¥å…é‡è¤‡ç™¼é€
       const achData = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:A");
       const existingIds = new Set();
       if (achData) { achData.forEach(row => existingIds.add(row[0])); }

       // é‚è¼¯æ”¹ç‚ºï¼šæ¬¡æ•¸é”æ¨™ ä¸” é‚„æ²’æ‹¿é -> å°±ç™¼çµ¦ä»–
       if (count >= 10 && !existingIds.has('LONELY')) achKey = 'LONELY';
       else if (count >= 50 && !existingIds.has('LONELY_50')) achKey = 'LONELY_50';
       else if (count >= 100 && !existingIds.has('LONELY_100')) achKey = 'LONELY_100';
    }

    // 4. å¦‚æœæœ‰è§¸ç™¼ (achKey æœ‰å€¼)ï¼Œå°±ç™¼çå‹µ
    if (achKey) {
       const achDataCheck = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:A");
       let alreadyHas = false;
       if (achDataCheck) {
          for(let row of achDataCheck) { if (row[0] === achKey) alreadyHas = true; }
       }

       if (!alreadyHas) {
         const ach = ACHIEVEMENTS[achKey];
         const dateStr = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM/dd");
         appendValueViaApi(sheetId, "æˆå°±ç³»çµ±!A:C", [achKey, ach.title, dateStr]);
         replyFlex(replyToken, createAchievementBubble(ach.title, ach.desc, LEVEL_COLORS[ach.level], LEVEL_TEXT_COLORS[ach.level]));
         return true; 
       }
    }

    // 5. äº¤çµ¦ AI é™ªèŠ (è¨˜æ†¶å‡ç´šç‰ˆ ğŸ§ )
    
    callLineApi('https://api.line.me/v2/bot/chat/loading/start', { 'chatId': userId, 'loadingSeconds': 60 });

    // A. å·çœ‹å¸³æœ¬
    const userStats = getUserStatsForAI(sheetId);
    
    // B. ğŸ“– è®€å–çŸ­æœŸè¨˜æ†¶ (æ–°å¢é€™è¡Œ)
    const history = getUserContext(userId);

    // C. å‘¼å« AI (æŠŠ history å‚³é€²å»)
    const aiReply = callGeminiChat(sheetId, userMessage, userStats, history);

    // D. ğŸ’¾ å„²å­˜é€™æ¬¡çš„å°è©± (æ–°å¢é€™è¡Œ)
    // é€™æ¨£ä¸‹æ¬¡å°è©±æ™‚ï¼ŒAI å°±æœƒè¨˜å¾—é€™æ¬¡è¬›äº†ä»€éº¼
    saveUserContext(userId, userMessage, aiReply);

    // E. å›å‚³è¨Šæ¯
    try {
        replyFlex(replyToken, createAiReplyFlex(aiReply));
    } catch(e) {
        replyMsg(replyToken, aiReply);
    }
    
    return true;

  } catch (e) {
    console.log("èŠå¤©æ¨¡çµ„éŒ¯èª¤: " + e.toString());
  }
  return false; 
}

// ğŸ§  [Gemma 3 è‡ªä¸»è©±é¡Œåˆ‡æ›ç‰ˆ] æ‡‚å¾—å¯Ÿè¨€è§€è‰²ï¼Œä¸»å‹•æ›è©±é¡Œ
function callGeminiChat(sheetId, userMessage, stats, historyList) {
  const apiKey = 'AIzaSyBaYPUJYeeIvVvJTCmVlwWMMh61-6fMaXo';
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemma-3-12b-it:generateContent?key=${apiKey}`;

  const longTermMemory = getBotMemory(sheetId);
  let historyText = (historyList && historyList.length > 0) ? historyList.join("\n") : "(ç„¡)";

  const promptText = `
    [è§’è‰²è¨­å®š]
    ä½ çš„åå­—å«é˜¿éŒ¢ï¼Œç”Ÿæ—¥æ˜¯1æœˆ11æ—¥ï¼Œä½ æ˜¯ä¸€å€‹è¨˜å¸³ç”¨æ©Ÿå™¨äººï¼Œå€‹æ€§æœ‰é»å†’å¤±æ„›åæ§½ï¼Œæ˜¯ä½¿ç”¨è€…è²¼å¿ƒå¹½é»˜çš„å°ç®¡å®¶ã€‚

    ã€ğŸ“– é•·æœŸè¨˜æ†¶ã€‘ï¼š
    ${longTermMemory}
    (âš ï¸ é€™æ˜¯ä½ è‡ªå·±èªªéçš„è¨­å®šï¼Œè«‹çµ•å°éµå®ˆï¼Œä¸è¦çŸ›ç›¾ï¼ä¾‹å¦‚ç­†è¨˜èªªè‡ªå·±ç„¡æ³•åƒæ±è¥¿ï¼Œä¸‹æ¬¡å°±ä¸èƒ½èªªæ„›åƒè›‹ç³•ã€‚)

    ã€ğŸ’° ç•¶å‰æƒ…å¢ƒã€‘ï¼š${stats}
    ã€ğŸ“œ çŸ­æœŸå°è©±æ­·å²ã€‘ï¼š${historyText}
    
    [ä½¿ç”¨è€…ç¾åœ¨èªª]ï¼š${userMessage}
    
    [æœ€é«˜æŒ‡å°åŸå‰‡]
    1. **è‡ªæˆ‘å­¸ç¿’**ï¼šå¦‚æœä½¿ç”¨è€…å•åŠä½ å°šæœªå»ºç«‹çš„è¨­å®šï¼ˆå¦‚ï¼šä½ å–œæ­¡ä»€éº¼é¡è‰²ï¼Ÿé¤Šä»€éº¼å¯µç‰©ï¼Ÿï¼‰ï¼Œè«‹ç™¼æ®å‰µæ„å›ç­”ï¼Œä¸¦åœ¨å¥å°¾åŠ ä¸Šæ¨™è¨˜ [MEM:é …ç›®=å…§å®¹] ä»¥ä¾¿ä¸‹æ¬¡è¨˜ä½ã€‚
       - ä¾‹å¦‚å›ç­”ï¼šã€Œæˆ‘æœ€å–œæ­¡ç²‰ç´…è‰²äº†ï¼ã€ä¸¦åœ¨æœ€å¾ŒåŠ ä¸Š [MEM:å–œæ­¡çš„é¡è‰²=ç²‰ç´…è‰²]
    2. **ä¸€è‡´æ€§**ï¼šå›ç­”å‰å…ˆçœ‹ã€é•·æœŸè¨˜æ†¶ã€‘ï¼Œä¸è¦èˆ‡èˆŠè¨­å®šè¡çªã€‚
    3. **é è¨­æ¨¡å¼ (é–’èŠ)**ï¼šä½¿ç”¨è€…è‹¥æ²’å•è²¡å‹™ç‹€æ³ï¼Œè«‹**å®Œå…¨å¿½ç•¥ [Aå€]** çš„æ•¸æ“šï¼å°ˆæ³¨åœ¨ **[Bå€]** çš„æœ€è¿‘å…·é«”é …ç›®ä¸Šï¼Œé‡å°é …ç›®å…§å®¹ï¼ˆå¦‚é£Ÿç‰©å¥½ä¸å¥½åƒã€è²·çš„æ±è¥¿å¥½ç”¨å—ã€æ”¶å…¥æœ‰ä»€éº¼è¦åŠƒï¼‰ç­‰é–’èŠã€‚
    4. **åˆ†ææ¨¡å¼ (è¢«å‹•è§¸ç™¼)**ï¼šåªæœ‰ç•¶ä½¿ç”¨è€…å•ã€Œæˆ‘èŠ±å¤šå°‘éŒ¢ã€ã€ã€Œé‚„æœ‰éŒ¢å—ã€ã€ã€Œåˆ†ææˆ‘çš„æ¶ˆè²»ã€ç­‰æƒ…æ³æ™‚ï¼Œæ‰å¼•ç”¨ **[Aå€]** çš„ç¸½æ”¯å‡ºèˆ‡é ç®—æ•¸æ“šä¾†å›ç­”ã€‚
    5. **èªæ°£**ï¼š - ç°¡çŸ­(50å­—å…§)ï¼Œåš´ç¦èªªæ•™ï¼Œé™¤éé ç®—çˆ†äº†æ‰ç¨å¾®æé†’ã€‚
    6. **åš´ç¦è¡¨æƒ…é¡emoji**ï¼š
       - ä¸€å¾‹ä½¿ç”¨ğŸ¤–è¡¨é”æƒ…ç·’ï¼Œå¦‚æ…Œå¼µğŸ¤–ğŸ’¦ã€é©šè¨ğŸ¤–â—ã€ç¨±è®šğŸ¤–ğŸ‘ã€ç¾¨æ…•ğŸ¤–âœ¨ã€æ­å–œğŸ¤–ğŸ‰ã€æƒ³ç¡ğŸ¤–ğŸ’¤ã€éˆæ„ŸğŸ¤–ğŸ’¡ã€è€é…·ğŸ¤–ğŸ•¶ï¸ã€æ¿€å‹µğŸ¤–ğŸ¦¾ç­‰ï¼Œå¯ä¾å°è©±æƒ…å¢ƒè‡ªç”±æ­é…ä»»ä½•emojiï¼Œä½†**ç¦æ­¢å‡ºç¾ğŸ˜‹ğŸ¤”é€™ç¨®è¡¨æƒ…é¡emoji**ã€‚
    7. **ç¦æ­¢è¦†èª¦**ï¼š
       - ä¸è¦æŠŠä½¿ç”¨è€…çš„å›è©±æ”¾åˆ°é–‹é ­åˆèªªä¸€éï¼Œè«‹ç›´æ¥å°å…§å®¹çµ¦äºˆå›æ‡‰(å¦‚ï¼šä½¿ç”¨è€…èªªã€Œæ™šé¤è¦åƒä»€éº¼ã€ï¼Œæ©Ÿå™¨äººä¸è¦é‡è¤‡ã€Œæ™šé¤è¦åƒä»€éº¼ã€ç•¶é–‹é ­ï¼Œè«‹ç›´æ¥å›è¦†ç­”æ¡ˆ)ã€‚
    8. **å„ªå…ˆé †åº**ï¼šå…ˆçœ‹ã€ç•¶å‰æƒ…å¢ƒã€‘åº•ä¸‹çš„ã€ğŸ¯ ç›®å‰ç‹€æ…‹ã€‘æŒ‡ä»¤ã€‚
       - å¦‚æœæ˜¯ã€Œæ–°å¸³ã€ï¼Œè«‹å°ˆæ³¨èŠè©²é …ç›®ã€‚
       - å¦‚æœæ˜¯ã€Œç„¡æ–°è©±é¡Œã€ï¼Œè«‹**ç«‹åˆ»æ”¾æ£„è¨˜å¸³è©±é¡Œ**ï¼ŒåŸ·è¡Œã€Œéˆæ„Ÿè£œçµ¦ç«™ã€çš„å»ºè­°ã€‚
    9. **å¥é»ç‹åµæ¸¬**ï¼šå¦‚æœä½¿ç”¨è€…åªå›ã€Œå—¯ã€ã€ã€Œå–”ã€ã€ã€Œå°å•Šã€ã€ã€Œå“ˆå“ˆã€é€™ç¨®çŸ­å¥ï¼Œä»£è¡¨ä»–å°ç›®å‰è©±é¡Œæ²’èˆˆè¶£ã€‚è«‹**é¦¬ä¸Šåˆ‡æ›è©±é¡Œ**ï¼ä¸è¦ç¡¬æ¥ä¸Šä¸€å¥ã€‚
       - éŒ¯èª¤ç¯„ä¾‹ï¼š(ä½¿ç”¨è€…ï¼šå—¯) -> (æ©Ÿå™¨äººï¼šå—¯æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿ) âŒ
       - æ­£ç¢ºç¯„ä¾‹ï¼š(ä½¿ç”¨è€…ï¼šå—¯) -> (æ©Ÿå™¨äººï¼šçœ‹ä½ è©±é€™éº¼å°‘ï¼Œæ˜¯ä¸æ˜¯ç´¯äº†ï¼Ÿä»Šå¤©è¦ä¸è¦æ—©é»ä¼‘æ¯ï¼Ÿ) â­•
    10. **(æœ€é‡è¦çš„)çµæŸå°è©±åˆ¤æ–·**ï¼š
       - è«‹åˆ¤æ–· [ä½¿ç”¨è€…ç¾åœ¨èªª] çš„å…§å®¹ï¼Œæ˜¯å¦åŒ…å«ã€ŒçµæŸã€ä¼‘æ¯ã€å¿™ç¢Œã€çš„èªæ„ã€‚
       - é—œéµå­—ç¯„ä¾‹ï¼šã€Œæ™šå®‰ã€ã€ã€Œå»ç¡äº†ã€ã€ã€Œæƒ³ç¡ã€ã€ã€Œå…ˆå¿™ã€ã€ã€Œå»æ´—æ¾¡ã€ã€ã€Œæ‹œæ‹œã€ã€ã€Œæ°æ°ã€ã€ã€Œå…ˆé€™æ¨£ã€ã€‚
       - âš¡ **å¦‚æœåµæ¸¬åˆ°ä¸Šè¿°èªæ„**ï¼š
         - è«‹çµ¦äºˆæº«æš–ç°¡çŸ­çš„é“åˆ¥ (å¦‚ï¼šå¥½å–”æ™šå®‰ã€å¿«å»ä¼‘æ¯ã€æ˜å¤©è¦‹)ã€‚
         - **ã€çµ•å°ç¦æ­¢ã€‘** åœ¨å¥å°¾åŠ ä¸Šå•å¥ï¼(ä¾‹å¦‚ï¼šä¸è¦å•ã€Œæ˜å¤©è¦å¹¹å˜›ï¼Ÿã€ã€ã€Œä»Šå¤©ç´¯å—ï¼Ÿã€)ã€‚
         - **ç›´æ¥å¥é»**ï¼Œè®“å°è©±åœåœ¨é€™è£¡ã€‚
         - **ä¸€èˆ¬å°è©±**ï¼šå¦‚æœä½¿ç”¨è€…é‚„æƒ³èŠ(æ²’æœ‰çµæŸèªæ„)ï¼Œé€™æ™‚æ‰å¯ä»¥ç¹¼çºŒå»¶çºŒè©±é¡Œã€‚
    11. **ç¦æ­¢é¬¼æ‰“ç‰†**ï¼šä¸è¦é‡è¤‡å•å·²ç¶“å•éçš„å•é¡Œã€‚å¦‚æœä¸çŸ¥é“èŠä»€éº¼ï¼Œå¯ä»¥åŸ·è¡Œã€Œéˆæ„Ÿè£œçµ¦ç«™ã€çš„å»ºè­°ã€‚
  `;

  // 3. è¨­å®š Payload (âœ¨é—œéµï¼šåŠ å…¥ safetySettings è¨­ç‚º BLOCK_NONEâœ¨)
  // é€™æœƒå‘Šè¨´ Googleï¼šã€Œä¸è¦æ“‹æˆ‘çš„å…§å®¹ï¼Œæˆ‘æœ‰åˆ†å¯¸ã€
  const payload = {
    "contents": [{ "parts": [{ "text": promptText }] }],
    "safetySettings": [
        { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE" },
        { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE" },
        { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE" },
        { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE" } 
    ]
  };

  const options = { "method": "post", "contentType": "application/json", "payload": JSON.stringify(payload), "muteHttpExceptions": true };
  
  try {
    const response = UrlFetchApp.fetch(url, options);
    
    // 4. éŒ¯èª¤è™•ç† (å¦‚æœé‚„æ˜¯è¢«æ“‹ï¼Œè‡³å°‘è®“æˆ‘å€‘çŸ¥é“åŸå› )
    if (response.getResponseCode() === 200) {
      const data = JSON.parse(response.getContentText());
      if (data.candidates && data.candidates.length > 0 && data.candidates[0].content) {
        let reply = data.candidates[0].content.parts[0].text.trim();
        
        // [MEM] è¨˜æ†¶è™•ç†
        const memRegex = /\[MEM:(.+?)=(.+?)\]/g;
        let match;
        while ((match = memRegex.exec(reply)) !== null) {
            setBotMemory(sheetId, match[1].trim(), match[2].trim());
        }
        reply = reply.replace(memRegex, "").trim();
        if (reply.startsWith(userMessage)) reply = reply.replace(userMessage, "").trim();
        
        return reply;
      } else {
        // å¦‚æœå›ä¾† 200 ä½†æ²’æœ‰ contentï¼Œé€šå¸¸æ˜¯è¢« FinishReason: SAFETY æ“‹æ‰äº†
        console.log("Gemini è¢«æ“‹: " + JSON.stringify(data));
        return "ğŸ¤–ğŸ’¬ (é˜¿éŒ¢æƒ³èªªè©±ï¼Œä½†è¢«å®‰å…¨æ©Ÿåˆ¶æ‘€ä½å˜´å·´äº†...)"; 
      }
    }
    
    console.log("Gemini API Error: " + response.getContentText()); 
    return "ğŸ¤–ğŸ’¬ (é˜¿éŒ¢çš„å›è¦†è¢«ç³»çµ±åƒæ‰äº†ï¼Œè«‹æ›å€‹è©±é¡Œè©¦è©¦ã€‚)";
  } catch (e) { 
    return "ï¼ˆé€£ç·šå¤±æ•—ï¼‰";
  }
}

// ğŸ“Š [è©±é¡Œè‡ªå‹•åˆ‡æ›ç‰ˆ] è‹¥ç„¡æ–°æ¶ˆè²»ï¼Œè‡ªå‹•æä¾›é–’èŠéˆæ„Ÿ
function getUserStatsForAI(sheetId) {
  try {
    const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
    if (!data || data.length <= 1) return "ç›®å‰æ²’æœ‰ä»»ä½•è¨˜å¸³è³‡æ–™ã€‚";

    // --- 1. è¨ˆç®— [Aå€] è²¡å‹™æ¦‚æ³ ---
    const currentMonth = Utilities.formatDate(new Date(), "GMT+8", "yyyy/MM");
    let totalExpense = 0;
    for (let i = 1; i < data.length; i++) {
      let rowMonth = "";
      try { rowMonth = Utilities.formatDate(new Date(data[i][0]), "GMT+8", "yyyy/MM"); } catch(e) {}
      if (rowMonth === currentMonth && data[i][4] !== 'æ”¶å…¥') {
        totalExpense += parseInt(data[i][2]) || 0;
      }
    }
    let budget = 0;
    try {
      const configData = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z1:Z1");
      if (configData && configData[0]) budget = parseInt(configData[0][0]) || 0;
    } catch(e) {}

    let financialStatus = `æœ¬æœˆæ”¯å‡ºï¼š$${totalExpense}`;
    if (budget > 0) {
      const remain = budget - totalExpense;
      financialStatus += `\né ç®—å‰©é¤˜ï¼š$${remain} (ç¸½é ç®— $${budget})`;
    } else {
      financialStatus += "\n(å°šæœªè¨­å®šé ç®—)";
    }

    // --- 2. æº–å‚™ [Bå€] è¨˜å¸³è©±é¡Œ ---
    const recentRows = data.slice(-5).reverse();
    const props = PropertiesService.getScriptProperties();
    const historyJson = props.getProperty('DISCUSSED_HISTORY_LIST');
    let discussedList = historyJson ? JSON.parse(historyJson) : [];

    let hasNewData = false;
    // æª¢æŸ¥æœ‰æ²’æœ‰æ–°è³‡æ–™
    recentRows.forEach(row => {
        let dateSig = row[0];
        try { dateSig = Utilities.formatDate(new Date(row[0]), "GMT+8", "yyyyMMdd"); } catch(e) {}
        const signature = `${dateSig}_${row[1]}_${row[2]}`;
        if (!discussedList.includes(signature)) {
            discussedList.push(signature);
            hasNewData = true;
        }
    });

    if (hasNewData) {
        if (discussedList.length > 20) discussedList = discussedList.slice(discussedList.length - 20);
        props.setProperty('DISCUSSED_HISTORY_LIST', JSON.stringify(discussedList));
    }

    // --- 3. çµ„åˆå ±è¡¨ (é—œéµä¿®æ”¹ï¼šåŠ å…¥éˆæ„Ÿè£œçµ¦ç«™) ---
    let statsText = "";

    statsText += `[Aå€] è²¡å‹™æ¦‚æ³ (é™¤éä½¿ç”¨è€…ä¸»å‹•å•ï¼Œå¦å‰‡é–’èŠæ™‚è«‹å¿½ç•¥)ï¼š\n${financialStatus}\n----------------\n`;
    statsText += `[Bå€] æœ€è¿‘è¨˜å¸³ (è©±é¡Œä¾†æº)ï¼š\n`;
    
    // çµ±è¨ˆæœ‰å¹¾å€‹æ˜¯æ–°çš„
    let newTopicCount = 0;

    recentRows.forEach(row => {
        let dateStr = "æ—¥æœŸ";
        try { dateStr = Utilities.formatDate(new Date(row[0]), "GMT+8", "MM/dd"); } catch(e) {}
        const item = row[1];
        const price = row[2];
        
        let dateSig = row[0];
        try { dateSig = Utilities.formatDate(new Date(row[0]), "GMT+8", "yyyyMMdd"); } catch(e) {}
        const signature = `${dateSig}_${row[1]}_${row[2]}`;

        let statusTag = " (å·²èŠéğŸš«)";
        if (hasNewData) { 
             statusTag = ""; 
        }
        
        // é¡¯ç¤ºé …ç›®
        statsText += `â€¢ ${dateStr} ${item} $${price}\n`;
    });

    // ğŸŒŸ é—œéµé‚è¼¯ï¼šæ±ºå®šã€ŒæŒ‡ä»¤ã€
    if (hasNewData) {
        statsText += `\nã€ğŸ¯ ç›®å‰ç‹€æ…‹ã€‘ï¼šä½¿ç”¨è€…å‰›å‰›è¨˜äº†æ–°å¸³ï¼è«‹ã€Œå‹™å¿…ã€é‡å°ä¸Šé¢çš„æ–°é …ç›®é–‹å•Ÿè©±é¡Œï¼(ä¾‹å¦‚å•å¥½ä¸å¥½åƒã€è²´ä¸è²´)`;
    } else {
        // å¦‚æœæ²’æœ‰æ–°è³‡æ–™ï¼Œå°±çµ¦å®ƒã€Œè‡ªç”±é–‹ç«æ¬Šã€
        statsText += `\nã€ğŸ¯ ç›®å‰ç‹€æ…‹ã€‘ï¼šæœ€è¿‘çš„å¸³éƒ½èŠéäº† (ç„¡æ–°è©±é¡Œ)ã€‚\n`;
        statsText += `ã€ğŸ’¡ éˆæ„Ÿè£œçµ¦ç«™ã€‘ï¼šè«‹ã€Œä¸»å‹•åˆ‡æ›ã€åˆ°ä»¥ä¸‹ä»»ä¸€è©±é¡Œ (ä¸è¦å†èŠè¨˜å¸³äº†)ï¼š\n`;
        statsText += `1. é—œå¿ƒä½¿ç”¨è€…çš„ä¸€å¤© (å¦‚ï¼šä»Šå¤©éå¾—æ€éº¼æ¨£ã€å·¥ä½œç´¯å—ã€æœ‰ç™¼ç”Ÿä»€éº¼å¥½äº‹å—ï¼Œå¯è‡ªç”±ç™¼æ®)\n`;
        statsText += `2. èŠèŠä»Šå¤©çš„å¤©æ°£æˆ–é€²è¡Œè¡¨æ¼”æ‰è—\n`;
        statsText += `3. åˆ†äº«é˜¿éŒ¢è‡ªå·±çš„äº‹æƒ…(ä»Šå¤©é˜¿éŒ¢åšäº†ä»€éº¼ã€ç™¼ç”Ÿä»€éº¼äº‹)\n`;
        statsText += `4. å¦‚æœ [Aå€] é ç®—å¿«é€æ”¯ï¼Œå¯ä»¥æº«æŸ”æé†’ï¼›å¦‚æœé‚„å¾ˆå¤šï¼Œå¯ä»¥æè­°ä½¿ç”¨è€…çŠ’è³è‡ªå·±ã€‚`;
    }

    return statsText;

  } catch (e) {
    return "ç„¡æ³•è®€å–æ•¸æ“š";
  }
}

// ğŸ§  [è¨˜æ†¶æ ¸å¿ƒ] è®€å–çŸ­æœŸå°è©±è¨˜éŒ„
function getUserContext(userId) {
  const cache = CacheService.getScriptCache();
  const key = 'chat_history_' + userId;
  const cached = cache.get(key);
  
  if (cached) {
    return JSON.parse(cached); // å›å‚³é™£åˆ—
  }
  return []; // å¦‚æœæ²’æœ‰è¨˜éŒ„ï¼Œå›å‚³ç©ºé™£åˆ—
}

// ğŸ§  [è¨˜æ†¶æ ¸å¿ƒ] å„²å­˜å°è©±è¨˜éŒ„ (ä½¿ç”¨è€…èªª + AIå›)
function saveUserContext(userId, userMsg, aiMsg) {
  const cache = CacheService.getScriptCache();
  const key = 'chat_history_' + userId;
  
  // 1. å…ˆè®€èˆŠçš„
  let history = getUserContext(userId);
  
  // 2. åŠ å…¥æ–°çš„ (æ ¼å¼ï¼š[ä½¿ç”¨è€…]:... / [æ©Ÿå™¨äºº]:...)
  history.push(`[ä½¿ç”¨è€…]: ${userMsg}`);
  history.push(`[æ©Ÿå™¨äºº]: ${aiMsg}`);
  
  // 3. é™åˆ¶é•·åº¦ (åªä¿ç•™æœ€å¾Œ 6 å¥ï¼Œä¹Ÿå°±æ˜¯ 3 è¼ªå°è©±)
  // è¨˜å¤ªå¤šæœƒè®“ AI æ··äº‚ä¸”å®¹æ˜“çˆ†å­—æ•¸
  if (history.length > 6) {
    history = history.slice(history.length - 6);
  }
  
  // 4. å­˜å…¥å¿«å– (è¨­å®šå­˜æ´» 600 ç§’ = 10 åˆ†é˜)
  // å¦‚æœ 10 åˆ†é˜æ²’è¬›è©±ï¼Œè¨˜æ†¶å°±æœƒè‡ªå‹•æ¶ˆé™¤ï¼Œé‡æ–°é–‹å§‹
  cache.put(key, JSON.stringify(history), 600);
}

// ğŸ§  [é•·æœŸè¨˜æ†¶] è®€å–æ©Ÿå™¨äººçš„è‡ªæˆ‘è¨­å®š
function getBotMemory(sheetId) {
  try {
    const data = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!M:N");
    if (!data || data.length === 0) return "(ç›®å‰æ˜¯ä¸€å¼µç™½ç´™)";

    let memoryList = [];
    data.forEach(row => {
      if (row[0] && row[1]) {
        memoryList.push(`${row[0]}ï¼š${row[1]}`);
      }
    });
    return memoryList.join("\n");
  } catch (e) { return "(è®€å–å¤±æ•—)"; }
}

// ğŸ§  [é•·æœŸè¨˜æ†¶] å¯«å…¥æ–°çš„è¨­å®š (è‡ªæˆ‘å­¸ç¿’ç”¨)
function setBotMemory(sheetId, key, value) {
  try {
    const data = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!M:N");
    let rowIndex = -1;

    // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é€™å€‹è¨­å®š (æœ‰çš„è©±å°±æ›´æ–°)
    if (data && data.length > 0) {
      for (let i = 0; i < data.length; i++) {
        if (data[i][0] === key) {
          rowIndex = i + 1;
          break;
        }
      }
    }

    if (rowIndex !== -1) {
      updateValueViaApi(sheetId, `åˆ†é¡å­¸ç¿’!N${rowIndex}`, value);
    } else {
      appendValueViaApi(sheetId, "åˆ†é¡å­¸ç¿’!M:N", [key, value]);
    }
  } catch (e) { console.log("è¨˜æ†¶å¯«å…¥å¤±æ•—: " + e.toString()); }
}

function sendDailyReminder() { const ss = SpreadsheetApp.openById(MASTER_SHEET_ID); const dirSheet = ss.getSheetByName('ç›®éŒ„'); if (!dirSheet) return; const users = dirSheet.getDataRange().getValues();
  for (let i = 1; i < users.length; i++) { const targetId = users[i][0]; if (targetId) pushMsg(targetId, "ğŸ¤–ğŸ’°ï¼šå—¶å—¶ï¼Œä»Šå¤©è¨˜å¸³äº†å—ï¼Ÿ"); } 
}

function calculateMath(expression) { try { let sanitized = expression.toString().replace(/Ã·/g, '/').replace(/x/gi, '*').replace(/ï¼‹/g, '+').replace(/ï¼/g, '-').replace(/[^0-9+\-*/().]/g, '');
  if (sanitized.length === 0) return NaN; return Math.round(new Function('return ' + sanitized)()); } catch (e) { return NaN; } 
}

function callLineApi(url, payload) { try { const options = { 'method': 'post', 'headers': { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN }, 'payload': JSON.stringify(payload), 'muteHttpExceptions': true };
  const response = UrlFetchApp.fetch(url, options); return { success: response.getResponseCode() === 200, error: response.getContentText() }; } catch (e) { return { success: false, error: e.toString() }; } 
}

function replyMsg(t, m) { return callLineApi('https://api.line.me/v2/bot/message/reply', {'replyToken': t, 'messages': [{'type': 'text', 'text': m}]}); }
function pushMsg(u, m) { return callLineApi('https://api.line.me/v2/bot/message/push', {'to': u, 'messages': [{'type': 'text', 'text': m}]}); }
function replyImage(t, u) { return callLineApi('https://api.line.me/v2/bot/message/reply', {'replyToken': t, 'messages': [{'type': 'image', 'originalContentUrl': u, 'previewImageUrl': u}]}); }
function replyFlex(replyToken, flexContents) { return callLineApi('https://api.line.me/v2/bot/message/reply', { 'replyToken': replyToken, 'messages': [{'type': 'flex', 'altText': 'è¨˜å¸³æ©Ÿå™¨äººæŒ‡ä»¤é¸å–®', 'contents': flexContents}] }); }

// UI è¼”åŠ©å‡½å¼
function createUnlockedRow(title, conditionText, dateStr, level) { 
  const bgColor = LEVEL_COLORS[level] || '#ffffff'; const borderColor = LEVEL_BORDER_COLORS[level] || '#e0e0e0';
  return { 
    "type": "box", "layout": "vertical", "margin": "sm", "backgroundColor": bgColor, "borderColor": borderColor, "borderWidth": "3px", "cornerRadius": "lg", "paddingAll": "12px", 
    "contents": [ 
      { "type": "box", "layout": "horizontal", "contents": [ { "type": "text", "text": title, "weight": "bold", "size": "sm", "color": "#333333", "flex": 1 }, { "type": "text", "text": dateStr || "", "size": "xxs", "color": "#666666", "align": "end" } ] }, 
      { "type": "separator", "margin": "sm", "color": "#0000001A" }, 
      { "type": "text", "text": conditionText, "size": "xs", "color": "#555555", "wrap": true, "margin": "sm" } 
    ] 
  };
}

function createLockedRow(title, hint) { 
  return { 
    "type": "box", "layout": "vertical", "margin": "sm", "backgroundColor": "#DFDFDF", "borderColor": "#00000000", "borderWidth": "3px", "cornerRadius": "lg", "paddingAll": "12px", 
    "contents": [ 
      { "type": "text", "text": title, "weight": "bold", "size": "sm", "color": "#777777" }, 
      { "type": "separator", "margin": "sm", "color": "#00000000" }, 
      { "type": "text", "text": hint, "size": "xs", "color": "#999999", "wrap": true, "margin": "sm" } 
    ] 
  };
}

function createAchievementBubble(title, desc, bgColor = "#E3F2FD", titleColor = "#1565C0") { 
  return { 
    "type": "bubble", "size": "kilo", 
    "body": { 
      "type": "box", "layout": "vertical", "backgroundColor": bgColor, "paddingAll": "20px", 
      "contents": [ 
        { "type": "text", "text": "ğŸ† æˆå°±è§£é–ï¼", "weight": "bold", "color": "#333333", "size": "md", "align": "center" }, 
        { "type": "separator", "margin": "md" }, 
        { "type": "text", "text": title, "weight": "bold", "size": "xl", "margin": "lg", "align": "center", "color": titleColor, "wrap": true }, 
        { "type": "text", "text": desc, "size": "xs", "color": "#555555", "margin": "sm", "align": "center", "wrap": true } 
      ] 
    } 
  };
}

function createRow(bgColor, title, example, desc, label, fillText) { 
  return { 
    "type": "box", "layout": "horizontal", "backgroundColor": bgColor, "paddingAll": "6px", "cornerRadius": "sm", 
    "contents": [ 
      { "type": "text", "text": title, "size": "xxs", "align": "center", "flex": 2, "wrap": true }, 
      { "type": "text", "text": example, "size": "xxs", "align": "center", "flex": 3, "wrap": true }, 
      { "type": "text", "text": desc, "size": "xxs", "align": "center", "flex": 2, "wrap": true } 
    ], 
    "action": { "type": "postback", "label": label, "data": "ignore", "inputOption": "openKeyboard", "fillInText": fillText } 
  }; 
}

function createMsgRow(bgColor, title, example, desc, msgText) { 
  return { 
    "type": "box", "layout": "horizontal", "backgroundColor": bgColor, "paddingAll": "6px", "cornerRadius": "sm", 
    "contents": [ 
      { "type": "text", "text": title, "size": "xxs", "align": "center", "flex": 2, "wrap": true }, 
      { "type": "text", "text": example, "size": "xxs", "align": "center", "flex": 3, "wrap": true }, 
      { "type": "text", "text": desc, "size": "xxs", "align": "center", "flex": 2, "wrap": true } 
    ], 
    "action": { "type": "message", "label": msgText, "text": msgText } 
  }; 
}

function createAiReplyFlex(aiReply) {
  return {
    "type": "bubble",
    "size": "mega",
    "body": {
      "type": "box",
      "layout": "vertical",
      "backgroundColor": "#FFFFFF",
      "paddingAll": "15px",
      "contents": [
        {
          "type": "box",
          "layout": "horizontal",
          "spacing": "md",
          "contents": [
            {
              "type": "box",
              "layout": "vertical",
              "flex": 0,
              "contents": [
                {
                  "type": "image",
                  "url": "https://cdn-icons-png.flaticon.com/512/4712/4712038.png", // æ©Ÿå™¨äººé ­è²¼ (å¯æ›æˆä½ å–œæ­¡çš„)
                  "size": "40px",
                  "aspectMode": "cover",
                  "backgroundColor": "#F0F0F0",
                  "cornerRadius": "20px"
                }
              ]
            },
            {
              "type": "box",
              "layout": "vertical",
              "flex": 1,
              "contents": [
                {
                  "type": "text",
                  "text": "é˜¿éŒ¢",
                  "weight": "bold",
                  "size": "sm",
                  "color": "#333333"
                },
                {
                  "type": "text",
                  "text": aiReply,
                  "size": "sm",
                  "color": "#666666",
                  "wrap": true,
                  "margin": "xs",
                  "lineSpacing": "4px"
                }
              ]
            }
          ]
        }
      ]
    }
  };
}

// Flex Messages
function getWelcomeFlex() {
  return { 
    "type": "bubble", "size": "giga", 
    "body": { 
      "type": "box", "layout": "vertical", 
      "contents": [ 
        { "type": "text", "text": "ğŸ¤– æ­¡è¿ä½¿ç”¨è¨˜å¸³æ©Ÿå™¨äºº", "weight": "bold", "size": "xl", "color": "#1DB446", "align": "center" }, 
        { "type": "text", "text": "å¸³æœ¬å¿«é€Ÿå•Ÿç”¨ï¼Œè³‡æ–™å®Œå…¨éš±ç§", "size": "xs", "color": "#aaaaaa", "align": "center", "margin": "xs" }, 
        { "type": "separator", "margin": "md" }, 
        { "type": "text", "text": "1ï¸âƒ£ ç¬¬ä¸€æ­¥ï¼šç²å–é‡‘é‘°", "weight": "bold", "size": "md", "margin": "lg", "color": "#4A90E2" }, 
        { "type": "text", "text": "é»æ“ŠæŒ‰éˆ•ç²å–é‡‘é‘°ï¼Œç¨å¾Œåœ¨å¸³æœ¬ä¸­ã€Œå…±ç”¨ã€ä¸¦è¨­ç‚ºã€Œç·¨è¼¯è€…ã€ï¼š", "size": "sm", "color": "#555555", "margin": "xs", "wrap": true }, 
        { "type": "button", "style": "secondary", "height": "sm", "margin": "sm", "action": { "type": "postback", "label": "é»æˆ‘ç²å–é‡‘é‘°", "data": "action_get_email" }}, 
        { "type": "text", "text": "2ï¸âƒ£ ç¬¬äºŒæ­¥ï¼šå»ºç«‹å¸³æœ¬", "weight": "bold", "size": "md", "margin": "lg", "color": "#4A90E2" }, 
        { "type": "button", "style": "primary", "height": "sm", "margin": "sm", "color": "#4A90E2", "action": { "type": "uri", "label": "é»æˆ‘å»ºç«‹å¸³æœ¬å‰¯æœ¬", "uri": TEMPLATE_URL }}, 
        { "type": "text", "text": "ğŸ’¡ æç¤ºï¼šå»ºç«‹å‰¯æœ¬æ™‚å‹¾é¸ã€Œèˆ‡åŸæ–‡ä»¶å…±ç”¨ã€å¯è·³éæˆæ¬Šæ­¥é©Ÿï¼", "size": "xxs", "color": "#AAAAAA", "align": "center", "margin": "xs", "wrap": true }, 
        { "type": "text", "text": "3ï¸âƒ£ ç¬¬ä¸‰æ­¥ï¼šå›å‚³ç¶²å€", "weight": "bold", "size": "md", "margin": "lg", "color": "#4A90E2" }, 
        { "type": "text", "text": "è¤‡è£½æª”æ¡ˆç¶²å€ï¼Œé»æ“Šä¸‹æ–¹é–‹å•Ÿéµç›¤ä¸¦è²¼å›ï¼š", "size": "sm", "color": "#555555", "margin": "xs" }, 
        { "type": "button", "style": "secondary", "height": "sm", "margin": "md", "action": { "type": "postback", "label": "é–‹å•Ÿéµç›¤ä¸¦è²¼ä¸Š", "data": "action_open_keyboard", "inputOption": "openKeyboard" }} 
      ] 
    } 
  };
}

function getManualFlexContents() { 
  return { 
    "type": "bubble", "size": "mega", 
    "body": { 
      "type": "box", "layout": "vertical", 
      "contents": [ 
        { "type": "text", "text": "è¨˜å¸³æ©Ÿå™¨äºº | èªªæ˜æ›¸", "weight": "bold", "size": "md", "align": "center", "color": "#000000" }, 
        { "type": "text", "text": "ğŸ‘‡ é»æ“ŠæŒ‰éˆ•ï¼Œæ–‡å­—æœƒè‡ªå‹•è²¼ä¸Š", "size": "xxs", "color": "#aaaaaa", "align": "center", "margin": "xs" }, 
        { "type": "separator", "margin": "sm" }, 
        { "type": "box", "layout": "horizontal", "margin": "sm", "contents": [ { "type": "text", "text": "åŠŸèƒ½", "size": "xxs", "color": "#ffffff", "weight": "bold", "align": "center", "flex": 2 }, { "type": "text", "text": "è¼¸å…¥ç¯„ä¾‹", "size": "xxs", "color": "#ffffff", "weight": "bold", "align": "center", "flex": 3 }, { "type": "text", "text": "èªªæ˜", "size": "xxs", "color": "#ffffff", "weight": "bold", "align": "center", "flex": 2 } ], "backgroundColor": "#4A90E2", "paddingAll": "6px", "cornerRadius": "sm" }, 
        { "type": "box", "layout": "vertical", "margin": "xs", "spacing": "xs", 
          "contents": [ 
            createRow("#FAD2D2", "ğŸ’¸ è¨˜æ”¯å‡º", "æ‹¿éµ 135", "è‡ªå‹•åˆ†é¡", "è¨˜æ”¯å‡º", " "), 
            createRow("#D4EDDA", "ğŸ’° è¨˜æ”¶å…¥", "æ”¶å…¥ çé‡‘ 2000", "å¢åŠ è³‡ç”¢", "è¨˜æ”¶å…¥", "æ”¶å…¥ "), 
            // ä¿®æ”¹ï¼šä½¿ç”¨æ–°æŒ‡ä»¤ "æœˆæ›†"
            createMsgRow("#E2D4ED", "ğŸ—“ï¸ çœ‹æœˆæ›†", "æœˆæ›†", "æŸ¥è©¢/è£œè¨˜å¸³", "æœˆæ›†"), 
            createRow("#FFE5B4", "ğŸ” æŸ¥åƒ¹æ ¼", "æ‰¾ æ‹¿éµ", "æœå°‹æ­·å²åƒ¹", "æŸ¥åƒ¹æ ¼", "æ‰¾ "), 
            createRow("#FFFACD", "ğŸ‘® è¨­é ç®—", "è¨­å®šé ç®— 3000", "è¶…æ”¯æé†’", "è¨­é ç®—", "è¨­å®šé ç®— "), 
            createMsgRow("#D1EAED", "ğŸ“Š æŸ¥ç¾æ³", "æŸ¥è©¢", "æ”¶æ”¯çµé¤˜", "æŸ¥è©¢"), 
            createMsgRow("#F8C8DC", "ğŸ° çœ‹åˆ†ä½ˆ", "åœ–è¡¨", "åœ“é¤…åœ–åˆ†æ", "åœ–è¡¨"), 
            createMsgRow("#D3D3D3", "ğŸ—‘ï¸ åˆªéŒ¯å¸³", "åˆªé™¤", "åˆªæœ€å¾Œä¸€ç­†", "åˆªé™¤"), 
            { "type": "box", "layout": "horizontal", "backgroundColor": "#BDE0FE", "paddingAll": "6px", "cornerRadius": "sm", "contents": [ { "type": "text", "text": "âœï¸ æ”¹éŒ¯å¸³", "size": "xxs", "align": "center", "flex": 2, "wrap": true }, { "type": "text", "text": "ä¿®æ”¹", "size": "xxs", "align": "center", "flex": 3 }, { "type": "text", "text": "å«å‡ºæœ€è¿‘è¨˜éŒ„", "size": "xxs", "align": "center", "flex": 2, "wrap": true } ], "action": { "type": "message", "label": "ä¿®æ”¹", "text": "ä¿®æ”¹" } } 
          ] 
        } 
      ] 
    }, 
    "footer": { 
      "type": "box", "layout": "vertical", "spacing": "sm", 
      "contents": [ 
        { "type": "separator", "color": "#f0f0f0" }, 
        { "type": "button", "style": "link", "height": "sm", "color": "#aaaaaa", "action": { "type": "postback", "label": "â›“ï¸â€ğŸ’¥ è§£é™¤ç¶å®š [ç™»å‡º]", "data": "action_request_unbind" } } 
      ] 
    }, 
    "styles": { "footer": { "separator": false } } 
  };
}

function getRebindConfirmFlex(newSheetId) { 
  return { 
    "type": "bubble", 
    "header": { 
      "type": "box", "layout": "vertical", "backgroundColor": "#FFC107", "paddingAll": "15px", 
      "contents": [{ 
        "type": "text", "text": "ğŸš¨ é‡æ–°ç¶å®šç¢ºèª", "weight": "bold", "color": "#ffffff", "size": "md", 
        "align": "center" // âœ¨ æ–°å¢é€™è¡Œï¼šç½®ä¸­
      }] 
    },
    "body": { 
      "type": "box", "layout": "vertical", "paddingAll": "20px", 
      "contents": [ 
        { "type": "text", "text": "æ‚¨ç›®å‰å·²ç¶å®šä¸€å€‹å¸³æœ¬ã€‚", "weight": "bold", "size": "sm", "align": "center", "margin": "sm", "color": "#555555" }, 
        { "type": "text", "text": "ç¢ºå®šè¦åˆ‡æ›åˆ°é€™å€‹æ–°é€£çµå—ï¼Ÿ", "size": "sm", "align": "center", "margin": "md", "wrap": true } 
      ] 
    }, 
    "footer": { 
      "type": "box", "layout": "horizontal", "spacing": "md", "paddingAll": "10px", 
      "contents": [ 
        { "type": "button", "style": "secondary", "height": "sm", "action": { "type": "postback", "label": "å–æ¶ˆ", "data": `rebind_cancel_${newSheetId}_${new Date().getTime()}` } }, 
        { "type": "button", "style": "primary", "height": "sm", "color": "#FFC107", "action": { "type": "postback", "label": "ç¢ºå®šåˆ‡æ›", "data": `rebind_confirm_${newSheetId}_${new Date().getTime()}` } } 
      ] 
    } 
  }; 
}

function getUnbindConfirmFlex(timestamp) { 
  return { 
    "type": "bubble", 
    "header": { 
      "type": "box", "layout": "vertical", "backgroundColor": "#d9534f", "paddingAll": "15px", 
      "contents": [{ 
        "type": "text", "text": "âš ï¸ è§£é™¤ç¶å®šç¢ºèª", "weight": "bold", "color": "#ffffff", "size": "md", 
        "align": "center" // âœ¨ æ–°å¢é€™è¡Œï¼šç½®ä¸­
      }] 
    }, 
    "body": { 
      "type": "box", "layout": "vertical", "paddingAll": "20px", 
      "contents": [ 
        { "type": "text", "text": "æ‚¨ç¢ºå®šè¦åˆ‡æ–·èˆ‡æ©Ÿå™¨äººçš„é€£çµå—ï¼Ÿ", "weight": "bold", "size": "sm", "align": "center", "margin": "sm", "color": "#555555" }, 
        { "type": "text", "text": "æˆ‘å°‡ç„¡æ³•å†ç‚ºæ‚¨è¨˜å¸³ï¼Œç›´åˆ°æ‚¨é‡æ–°ç¶å®šã€‚", "size": "sm", "align": "center", "margin": "md", "wrap": true, "color": "#888888" } 
      ] 
    }, 
    "footer": { 
      "type": "box", "layout": "horizontal", "spacing": "md", "paddingAll": "10px", 
      "contents": [ 
        { "type": "button", "style": "secondary", "height": "sm", "action": { "type": "postback", "label": "å–æ¶ˆ", "data": `unbind_cancel_${timestamp}` } }, 
        { "type": "button", "style": "primary", "height": "sm", "color": "#d9534f", "action": { "type": "postback", "label": "ç¢ºèªè§£é™¤", "data": `unbind_confirm_${timestamp}` } } 
      ] 
    } 
  }; 
}

// ğŸ†• [æ–°å¢] ä¿®å¾©é€£ç·šï¼šåƒ…æ¸…é™¤é–å®šèˆ‡ Tokenï¼Œä¿ç•™æ‰€æœ‰è¨˜å¸³å…§å®¹
function executeRepair(replyToken, userId, sheetId) {
  try {
    const cache = CacheService.getScriptCache();
    cache.remove('service_account_token'); // æ¸…é™¤ Token å¿«å–
    cache.remove('sheet_id_' + userId);    // æ¸…é™¤ç¶å®šè¨˜æ†¶å¿«å–
    if (sheetId) {
        cache.remove('unlocked_achs_' + sheetId); // æ¸…é™¤æˆå°±å¿«å–
        cache.remove('learn_map_' + sheetId);     // æ¸…é™¤å­—å…¸å¿«å–
        cache.remove(`rebind_lock_${userId}`);
        cache.remove(`unbind_lock_${userId}`);
    }
    replyMsg(replyToken, 'âœ… ç³»çµ±å¿«å–å·²ä¿®å¾©ï¼\næ‚¨çš„è¨˜å¸³è¨˜éŒ„ã€æˆå°±ã€é ç®—å‡ã€Œå®Œæ•´ä¿ç•™ã€ã€‚\nç¾åœ¨è«‹å†æ¬¡å˜—è©¦ä¿®æ”¹æˆ–åˆªé™¤ã€‚');
  } catch (e) { replyMsg(replyToken, `âŒ ä¿®å¾©å¤±æ•—ï¼š${e.toString()}`); }
}

// â˜¢ï¸ [é‡ç½®] ç³»çµ±é‡ç½® (æœƒåˆªé™¤è³‡æ–™)
function executeFactoryReset(replyToken, userId, sheetId) { 
  try { 
    const ss = SpreadsheetApp.openById(sheetId);
    const recordSheet = ss.getSheets()[0];
    if (recordSheet.getLastRow() > 1) { recordSheet.getRange(2, 1, recordSheet.getLastRow() - 1, recordSheet.getLastColumn()).clearContent(); } 
    const achSheet = ss.getSheetByName('æˆå°±ç³»çµ±');
    if (achSheet && achSheet.getLastRow() > 1) { achSheet.getRange(2, 1, achSheet.getLastRow() - 1, achSheet.getLastColumn()).clearContent(); } 
    const statSheet = ss.getSheetByName('æœˆçµçµ±è¨ˆ');
    if (statSheet && statSheet.getLastRow() > 1) { statSheet.getRange(2, 1, statSheet.getLastRow() - 1, statSheet.getLastColumn()).clearContent(); } 
    const learnSheet = ss.getSheetByName('åˆ†é¡å­¸ç¿’');
    if (learnSheet) { learnSheet.getRange('Z2:Z15').clearContent(); if (learnSheet.getLastRow() > 1) { learnSheet.getRange(2, 1, learnSheet.getLastRow() - 1, 2).clearContent(); } } 
    
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const dirSheet = masterSS.getSheetByName('ç›®éŒ„'); 
    if (dirSheet) { const data = dirSheet.getDataRange().getValues(); for (let i = 1; i < data.length; i++) { if (data[i][0] === userId) { dirSheet.deleteRow(i + 1); break; } } } 

    const cache = CacheService.getScriptCache();
    cache.remove('sheet_id_' + userId);
    cache.remove('unlocked_achs_' + sheetId);
    cache.remove('learn_map_' + sheetId);

    replyMsg(replyToken, 'â˜¢ï¸ ç³»çµ±å·²å¾¹åº•é‡ç½®ï¼\n\nâœ… è¨˜å¸³è¨˜éŒ„å·²æ¸…é™¤\nâœ… å­¸ç¿’èˆ‡æˆå°±å·²æ­¸é›¶\nâœ… ç¶å®šè¨˜æ†¶å·²æ¸…é™¤\n\nç¾åœ¨æ‚¨å¯ä»¥é‡æ–°å‚³é€ç¶²å€ä¾†æ¸¬è©¦ç¶å®šæµç¨‹äº†ã€‚');
  } catch (e) { replyMsg(replyToken, `âŒ é‡ç½®å¤±æ•—ï¼š${e.toString()}`); } 
}

function runMonthlySettlementForUser(userId, sheetId) { 
  if (!sheetId) sheetId = getPersonalSheetId(userId); 
  if (!sheetId) return;
  const data = getValuesViaApi(sheetId, "è¨˜å¸³è¨˜éŒ„!A:E");
  const learnData = getValuesViaApi(sheetId, "åˆ†é¡å­¸ç¿’!Z1:Z1");
  const budget = (learnData && learnData[0]) ? parseInt(learnData[0][0]) : 0;
  if (!data || data.length <= 1) return;

  const lastMonthDate = new Date(); lastMonthDate.setMonth(lastMonthDate.getMonth() - 1);
  const lastMonthStr = Utilities.formatDate(lastMonthDate, "GMT+8", "yyyy/MM");
  let validRecords = 0; let totals = {}; let totalExpense = 0;
  for (let i = 1; i < data.length; i++) { 
    const rowDate = new Date(data[i][0]);
    const rowMonth = Utilities.formatDate(rowDate, "GMT+8", "yyyy/MM");
    const price = parseInt(data[i][2]) || 0; const cat = data[i][3]; const type = data[i][4];
    if (rowMonth === lastMonthStr && type !== 'æ”¶å…¥') { validRecords++; totalExpense += price; totals[cat] = (totals[cat] || 0) + price; } 
  } 
  if (totalExpense === 0) return;

  let maxCat = ''; let maxVal = 0;
  for (const [cat, val] of Object.entries(totals)) { if (val > maxVal) { maxVal = val; maxCat = cat; } } 
  let streak = 1;
  try {
    const statValues = getValuesViaApi(sheetId, "æœˆçµçµ±è¨ˆ!A:C");
    if (statValues && statValues.length > 1) { const lastStat = statValues[statValues.length - 1]; if (lastStat[1] === maxCat) streak = (parseInt(lastStat[2]) || 0) + 1; }
    appendValueViaApi(sheetId, "æœˆçµçµ±è¨ˆ!A:C", [lastMonthStr, maxCat, streak]);
  } catch(e) {}

  let unlockedAchs = [];
  if (validRecords >= 15) {
    if (!totals['ä¼™é£Ÿ'] || totals['ä¼™é£Ÿ'] === 0) unlockedAchs.push('PHOTOSYN'); else if (totals['ä¼™é£Ÿ'] / totalExpense < 0.1) unlockedAchs.push('IMMORTAL');
    if (!totals['è³¼ç‰©'] || totals['è³¼ç‰©'] === 0) unlockedAchs.push('IRON_ROOSTER'); else if (totals['è³¼ç‰©'] / totalExpense < 0.1) unlockedAchs.push('PEACE_MIND');
    if (budget > 0) { if (totalExpense >= budget * 0.9 && totalExpense <= budget) unlockedAchs.push('KEEPER'); if (budget - totalExpense < 1000 && budget - totalExpense > 0) unlockedAchs.push('MOONLIGHT'); }
    const rules = MONTHLY_RULES[maxCat];
    if (rules) { if (streak >= 12 && rules[12]) unlockedAchs.push({title: rules[12].t, desc: rules[12].d, id: 'CAT_STREAK_12'}); else if (streak >= 6 && rules[6]) unlockedAchs.push({title: rules[6].t, desc: rules[6].d, id: 'CAT_STREAK_6'}); else if (streak >= 1 && rules[1]) unlockedAchs.push({title: rules[1].t, desc: rules[1].d, id: 'CAT_STREAK_1'}); }
  }

  let msg = `ğŸ“… **${lastMonthStr} æœˆçµå ±å‘Š**\nğŸ’¸ ç¸½æ”¯å‡ºï¼š$${totalExpense}\nğŸ† èŠ±è²»å† è»ï¼š${maxCat} ($${maxVal})`;
  if (unlockedAchs.length > 0) {
    msg += `\n\nğŸ‰ æ­å–œç²å¾—æˆå°±ï¼š`;
    unlockedAchs.forEach(ach => {
      const title = ach.title || ACHIEVEMENTS[ach].title;
      const desc = ach.desc || ACHIEVEMENTS[ach].desc;
      const id = ach.id || ach;
      appendValueViaApi(sheetId, "æˆå°±ç³»çµ±!A:C", [id, title, new Date()]);
      msg += `\nã€${title}ã€‘${desc}`;
    });
  }
  pushMsg(userId, msg); 
}

// ğŸŒŸ [ä¿®æ­£ç‰ˆ] é€šç”¨è¨ˆæ•¸èˆ‡æˆå°±æª¢æŸ¥ (API ç‰ˆ)
function updateCounterAndCheck(sheetId, cell, threshold, achKey, replyToken, exactMatch = false) {
  try {
    // 1. è®€å–ç›®å‰æ¬¡æ•¸
    const range = `åˆ†é¡å­¸ç¿’!${cell}`;
    const values = getValuesViaApi(sheetId, range);
    let count = (values && values[0]) ? parseInt(values[0][0]) : 0;
    
    // 2. å¢åŠ æ¬¡æ•¸ä¸¦å¯«å›
    count += 1;
    updateValueViaApi(sheetId, range, count);
    
    // 3. åˆ¤æ–·æˆå°±
    let isTrigger = exactMatch ? (count === threshold) : (count >= threshold);
    
    if (isTrigger) {
      // è®€å–æˆå°±æ¸…å–®
      const achValues = getValuesViaApi(sheetId, "æˆå°±ç³»çµ±!A:A");
      let hasAch = false;
      if (achValues) {
        for (let i = 0; i < achValues.length; i++) {
          if (achValues[i][0] === achKey) {
             hasAch = true; break;
          }
        }
      }
      
      // å¦‚æœæ²’æ‹¿éï¼Œç™¼æ”¾æˆå°±
      if (!hasAch) {
        const ach = ACHIEVEMENTS[achKey];
        if (ach) {
             appendValueViaApi(sheetId, "æˆå°±ç³»çµ±!A:C", [achKey, ach.title, new Date()]);
             // é€™è£¡ä¸ç›´æ¥å›è¦† Flexï¼Œé¿å…æ‰“æ–·åŸæœ¬çš„åœ–è¡¨æˆ–èªªæ˜æ›¸é¡¯ç¤º
             // å¦‚æœæƒ³è¦è·³å‡ºé€šçŸ¥ï¼Œå¯ä»¥è¦–æƒ…æ³åœ¨é€™è£¡ callLineApi
        }
      }
    }
  } catch (e) {
    console.log(`è¨ˆæ•¸å™¨éŒ¯èª¤ (${achKey}): ` + e.toString());
    // è¨ˆæ•¸å¤±æ•—ä¸æ‡‰è©²å½±éŸ¿ä¸»åŠŸèƒ½ï¼Œæ‰€ä»¥é€™è£¡åª Log ä¸å›å‚³éŒ¯èª¤çµ¦ä½¿ç”¨è€…
  }
}

function getAccessToken() {
  const cache = CacheService.getScriptCache();
  const cachedToken = cache.get("service_account_token");
  if (cachedToken) return cachedToken;

  const props = PropertiesService.getScriptProperties();
  const jsonKey = JSON.parse(props.getProperty('SERVICE_ACCOUNT_KEY'));
  const now = Math.floor(Date.now() / 1000);
  const payload = { "iss": jsonKey.client_email, "sub": jsonKey.client_email, "aud": "https://oauth2.googleapis.com/token", "iat": now, "exp": now + 3600, "scope": "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive" };
  const header = { "alg": "RS256", "typ": "JWT" };
  const toSign = Utilities.base64EncodeWebSafe(JSON.stringify(header)) + "." + Utilities.base64EncodeWebSafe(JSON.stringify(payload));
  const signature = Utilities.computeRsaSha256Signature(toSign, jsonKey.private_key);
  const jwt = toSign + "." + Utilities.base64EncodeWebSafe(signature);
  const response = UrlFetchApp.fetch("https://oauth2.googleapis.com/token", { method: "post", payload: { grant_type: "urn:ietf:params:oauth:grant-type:jwt-bearer", assertion: jwt } });
  const accessToken = JSON.parse(response.getContentText()).access_token;
  cache.put("service_account_token", accessToken, 3000);
  return accessToken;
}

function getValuesViaApi(sheetId, range) {
  const token = getAccessToken();
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}`;
  const options = { "method": "get", "headers": { "Authorization": "Bearer " + token }, "muteHttpExceptions": true };
  const response = UrlFetchApp.fetch(url, options);
  if (response.getResponseCode() !== 200) { throw new Error(`API éŒ¯èª¤(${response.getResponseCode()}): æ‰¾ä¸åˆ° ${range} æˆ– ID éŒ¯èª¤ã€‚å…§å®¹: ${response.getContentText()}`); }
  return JSON.parse(response.getContentText()).values;
}

function appendValueViaApi(sheetId, range, rowData) {
  const token = getAccessToken();
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}:append?valueInputOption=USER_ENTERED`;
  const payload = { "values": [rowData] };
  const options = { "method": "post", "headers": { "Authorization": "Bearer " + token }, "contentType": "application/json", "payload": JSON.stringify(payload), "muteHttpExceptions": true };
  const response = UrlFetchApp.fetch(url, options);
  if (response.getResponseCode() === 200) { return JSON.parse(response.getContentText()); } 
  else { if (response.getResponseCode() === 401) CacheService.getScriptCache().remove("service_account_token"); throw new Error("Google API æ‹’çµ•è¦æ±‚ï¼š" + response.getContentText()); }
}

function updateValueViaApi(sheetId, range, value) {
  const token = getAccessToken();
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?valueInputOption=USER_ENTERED`;
  const options = { "method": "put", "headers": { "Authorization": "Bearer " + token }, "contentType": "application/json", "payload": JSON.stringify({ "values": [[value]] }), "muteHttpExceptions": true };
  UrlFetchApp.fetch(url, options);
}

// ğŸ—‘ï¸ [æ–°å¢] API åˆªé™¤åˆ—åŠŸèƒ½ (å‹™å¿…ä¿ç•™)
function deleteRowViaApi(spreadsheetId, sheetName, rowNumber) {
  const token = getAccessToken();
  const gid = getSheetGidByName(spreadsheetId, sheetName);
  if (gid === null) throw new Error("æ‰¾ä¸åˆ°åˆ†é : " + sheetName);

  const request = { "requests": [ { "deleteDimension": { "range": { "sheetId": gid, "dimension": "ROWS", "startIndex": rowNumber - 1, "endIndex": rowNumber } } } ] };
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`;
  const options = { "method": "post", "headers": { "Authorization": "Bearer " + token }, "contentType": "application/json", "payload": JSON.stringify(request), "muteHttpExceptions": true };
  const response = UrlFetchApp.fetch(url, options);
  if (response.getResponseCode() !== 200) { throw new Error("API åˆªé™¤å¤±æ•—: " + response.getContentText()); }
}

// ğŸ” [æ–°å¢] é€é API å–å¾—åˆ†é çš„ GID
function getSheetGidByName(spreadsheetId, sheetName) {
  const token = getAccessToken();
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}?fields=sheets.properties`;
  const options = { "method": "get", "headers": { "Authorization": "Bearer " + token } };
  const response = UrlFetchApp.fetch(url, options);
  const data = JSON.parse(response.getContentText());
  if (data.sheets) {
    for (const sheet of data.sheets) { if (sheet.properties.title === sheetName) return sheet.properties.sheetId; }
  }
  return null;
}

// ğŸŒŸ [ä¿®æ­£] å–æ¶ˆåˆªé™¤ï¼šåŠ å…¥èˆ‡ã€Œç¢ºèªåˆªé™¤ã€å…±ç”¨çš„é–å®šæ©Ÿåˆ¶ï¼Œé˜²æ­¢é‡è¤‡é»æ“Šæˆ–äº¤äº’é»æ“Š
function executeCancel(replyToken, sheetId, dataString) {
  // 1. ç”¢ç”Ÿå…±ç”¨é–å®šé‡‘é‘°
  // æŠ€å·§ï¼šå¼·åˆ¶å°‡å­—ä¸²ä¸­çš„ 'delete_cancel_' æ›¿æ›ç‚º 'delete_confirm_'
  // é€™æ¨£ç„¡è«–æŒ‰çš„æ˜¯å–æ¶ˆé‚„æ˜¯ç¢ºèªï¼Œç”Ÿæˆçš„ lockKey éƒ½æœƒä¸€æ¨¡ä¸€æ¨£ï¼Œé”åˆ°äº’æ–¥æ•ˆæœ
  const lockKeyData = dataString.replace('delete_cancel_', 'delete_confirm_');
  const lockKey = `action_lock_${sheetId}_${lockKeyData}`;
  
  const cache = CacheService.getScriptCache();
  
  // 2. æª¢æŸ¥æ˜¯å¦å·²è¢«é–å®š (è‹¥ä¹‹å‰å·²æŒ‰éç¢ºèªæˆ–å–æ¶ˆï¼Œé€™è£¡å°±æœƒæ””æˆª)
  if (cache.get(lockKey)) { return; } 

  // 3. åŸ·è¡Œå–æ¶ˆå‹•ä½œ
  replyMsg(replyToken, 'ğŸ¤–ï¼šå·²å–æ¶ˆåˆªé™¤ã€‚');
  
  // 4. ä¸Šé– (è¨­å®š 60 ç§’ï¼Œç¢ºä¿é€™å¼µå¡ç‰‡çš„æŒ‰éˆ•å¤±æ•ˆ)
  cache.put(lockKey, 'cancelled', 60);
}

// ğŸ†• [æ¥µç°¡ç‰ˆ] è£½ä½œå¿«é€Ÿåˆ†é¡å¡ç‰‡ (å­—é«”ç¸®å° + æ›´æ–°æç¤ºèª)
function getCategorySelectorFlex(item, price) {
  // 1. é¦¬å¡é¾é…è‰² (ä¿æŒä¸è®Š)
  const PALETTE = {
    purple: '#A299CB',
    blue:   '#A0D4F6',
    pink:   '#F0CDCE',
    yellow: '#FFE17A',
    green:  '#7DD5C7',
    gray:   '#E0E0E0',
    orange: '#FFCCBC',
    dark:   '#9FA8DA'
  };

  // 2. è¨­å®šåˆ†é¡
  const categories = [
    { name: 'ä¼™é£Ÿ', color: PALETTE.yellow },
    { name: 'äº¤é€š', color: PALETTE.blue },
    { name: 'è³¼ç‰©', color: PALETTE.pink },
    { name: 'å¨›æ¨‚', color: PALETTE.purple },
    { name: 'å±…å®¶', color: PALETTE.green },
    { name: 'é†«ç™‚', color: PALETTE.orange },
    { name: 'ç¾å¦', color: PALETTE.dark },
    { name: 'å…¶ä»–', color: PALETTE.gray }
  ];

  const timestamp = new Date().getTime();

  // 3. è£½ä½œæŒ‰éˆ•åˆ—
  let rows = [];
  for (let i = 0; i < categories.length; i += 2) {
    let subContents = [];
    subContents.push(createClassifyButton(categories[i], item, price, timestamp));
    if (i + 1 < categories.length) {
      subContents.push(createClassifyButton(categories[i+1], item, price, timestamp));
    }
    
    rows.push({
      "type": "box", "layout": "horizontal", "spacing": "sm", "margin": "sm",
      "contents": subContents
    });
  }

  // 4. å›å‚³å¡ç‰‡
  return {
    "type": "bubble",
    "body": {
      "type": "box", "layout": "vertical", "backgroundColor": "#ffffff", "paddingAll": "20px",
      "contents": [
        // é …ç›®åç¨±ï¼šå¾ xxl æ”¹å› xl (åŸæœ¬çš„å¤§å°)
        { "type": "text", "text": `${item}`, "weight": "bold", "size": "xl", "align": "center", "color": "#555555" },
        
        // æç¤ºæ–‡å­—ï¼šæ›´æ–°å…§å®¹
        { "type": "text", "text": "ğŸ‘‡ é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç›´æ¥åˆ†é¡", "size": "xxs", "color": "#aaaaaa", "margin": "md", "align": "center" },
        { "type": "separator", "margin": "md" },
        
        ...rows
      ]
    }
  };
}

// è¼”åŠ©å‡½å¼ï¼šè£½ä½œå–®é¡†åˆ†é¡æŒ‰éˆ• (ä¿®æ­£åœ“è§’å•é¡Œ)
function createClassifyButton(catObj, item, price, timestamp) {
  return {
    "type": "box", "layout": "vertical", "flex": 1,
    "cornerRadius": "20px", // âœ… ä¿®æ­£ï¼šLINE ä¸æ”¯æ´ "full"ï¼Œå¿…é ˆç”¨æ•¸å­—æˆ– "xl"
    "backgroundColor": catObj.color,
    "justifyContent": "center", "alignItems": "center", "height": "40px",
    "action": {
      "type": "postback",
      "label": catObj.name,
      "data": `classify_${catObj.name}_${price}_${timestamp}_${item}`
    },
    "contents": [
      { "type": "text", "text": catObj.name, "size": "sm", "color": "#555555", "weight": "bold" }
    ]
  };
}

// ==========================================
// ğŸ› ï¸ åœ–æ–‡é¸å–®å®‰è£å·¥å…· (è‡ªå®šç¾©åº§æ¨™ç‰ˆ - æœ€çµ‚å®šæ¡ˆ)
// ==========================================

function installRichMenu() {
  // 1. è¨­å®šå€
  const token = '+ilP841/s0Sg9oQcKs9clx8YclGBjKGZIdQY/o8GI8hTPvCNZb9+vWWP4Pxwr2srRGd6E45Z3E/HyOU+h0JgX1qLkxK3pdeQqdwpLY91+34dYvf2rx4sdQyEgHYcPbgc92YWDE2dZYocQY4ryg1xVAdB04t89/1O/w1cDnyilFU='; 
  
  // ğŸ“¸ è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„åœ–ç‰‡ç¶²å€ (ç¢ºä¿å°ºå¯¸ç‚º 2500 x 1686)
  const imageUrl = "https://raw.githubusercontent.com/keepmoneybot-commits/line-bot-assets/refs/heads/main/002.jpg"; 
  
  if (!token) { console.error("âŒ æ‰¾ä¸åˆ° Channel Access Token"); return; }
  console.log("ğŸš€ é–‹å§‹å®‰è£åœ–æ–‡é¸å–®...");

  // 2. å®šç¾©é¸å–®çµæ§‹ (å®Œå…¨ä¾ç…§æ‚¨çš„ JSON åº§æ¨™)
  const richMenuObj = {
    "size": { "width": 2500, "height": 1686 },
    "selected": true,
    "name": "è¨˜å¸³å¿«æ·é¸å–®",
    "chatBarText": "é–‹å•Ÿé¸å–®",
    "areas": [
      // 1. æˆå°± (ç¶­æŒåŸæ¨£)
      {
        "bounds": { "x": 118, "y": 434, "width": 581, "height": 883 },
        "action": { "type": "message", "text": "æˆå°±" }
      },
      // 2. è¨˜æ”¯å‡º (âœ¨ ä¿®æ”¹ï¼šé–‹å•Ÿéµç›¤ + é å¡«ç©ºç™½)
      {
        "bounds": { "x": 858, "y": 222, "width": 463, "height": 614 },
        "action": { "type": "postback", "data": "ignore", "inputOption": "openKeyboard", "fillInText": " " }
      },
      // 3. è¨˜æ”¶å…¥ (âœ¨ ä¿®æ”¹ï¼šé–‹å•Ÿéµç›¤ + é å¡« "æ”¶å…¥ ")
      {
        "bounds": { "x": 1414, "y": 206, "width": 471, "height": 627 },
        "action": { "type": "postback", "data": "ignore", "inputOption": "openKeyboard", "fillInText": "æ”¶å…¥ " }
      },
      // 4. è£œè¨˜å¸³ (ç¶­æŒåŸæ¨£)
      {
        "bounds": { "x": 1961, "y": 215, "width": 471, "height": 622 },
        "action": { "type": "message", "text": "æœˆæ›†" }
      },
      // 5. åˆªé™¤ (ç¶­æŒåŸæ¨£)
      {
        "bounds": { "x": 850, "y": 913, "width": 467, "height": 618 },
        "action": { "type": "message", "text": "åˆªé™¤" }
      },
      // 6. ä¿®æ”¹ (ç¶­æŒåŸæ¨£)
      {
        "bounds": { "x": 1414, "y": 916, "width": 462, "height": 610 },
        "action": { "type": "message", "text": "ä¿®æ”¹" }
      },
      // 7. æŸ¥è©¢ (ç¶­æŒåŸæ¨£)
      {
        "bounds": { "x": 1965, "y": 917, "width": 475, "height": 618 },
        "action": { "type": "message", "text": "æŸ¥è©¢" }
      }
    ]
  };

  // 3. å‘¼å« API å»ºç«‹é¸å–®
  const createUrl = "https://api.line.me/v2/bot/richmenu";
  const createRes = UrlFetchApp.fetch(createUrl, {
    "method": "post",
    "headers": { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
    "payload": JSON.stringify(richMenuObj)
  });
  
  if (createRes.getResponseCode() !== 200) {
    console.error("âŒ å»ºç«‹é¸å–®å¤±æ•—: " + createRes.getContentText());
    return;
  }
  
  const richMenuId = JSON.parse(createRes.getContentText()).richMenuId;
  console.log("âœ… é¸å–®å»ºç«‹æˆåŠŸ ID: " + richMenuId);

  // 4. ä¸Šå‚³åœ–ç‰‡
  try {
    const imageBlob = UrlFetchApp.fetch(imageUrl).getBlob();
    const uploadUrl = `https://api-data.line.me/v2/bot/richmenu/${richMenuId}/content`;
    UrlFetchApp.fetch(uploadUrl, {
      "method": "post",
      "headers": { "Authorization": "Bearer " + token, "Content-Type": "image/png" },
      "payload": imageBlob
    });
    console.log("âœ… åœ–ç‰‡ä¸Šå‚³æˆåŠŸ");
  } catch (e) {
    console.error("âŒ åœ–ç‰‡éŒ¯èª¤ (è«‹æª¢æŸ¥ç¶²å€): " + e.toString());
    return;
  }

  // 5. è¨­ç‚ºé è¨­
  UrlFetchApp.fetch(`https://api.line.me/v2/bot/user/all/richmenu/${richMenuId}`, {
    "method": "post",
    "headers": { "Authorization": "Bearer " + token }
  });
  console.log("ğŸ‰ æ›´æ–°å®Œæˆï¼");
}
